<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perturb-seq: using bulk reference to evaluate strengths of CRISPRa gene perturbation • PhiSpace</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Perturb-seq: using bulk reference to evaluate strengths of CRISPRa gene perturbation">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PhiSpace</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Perturb-seq: using bulk reference to evaluate
strengths of CRISPRa gene perturbation</h1>
                        <h4 data-toc-skip class="author">Jiadong
Mao</h4>
            
            <h4 data-toc-skip class="date">2025-08-15</h4>
      

      <div class="hidden name"><code>PerturbSeq.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="highlights">Highlights<a class="anchor" aria-label="anchor" href="#highlights"></a>
</h3>
<ul>
<li><p>Bulk reference + single-cell (Perturb-seq) query;</p></li>
<li><p>Leveraging detailed T cell state annotation in bulk
reference.</p></li>
<li><p>Evaluate contribution of perturbation of individual genes to T
cell state development.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>CRISPR screens are high-throughput techniques to systematically
manipulate genes across the genome and observe the resulting phenotypes.
CRISPR activation (CRISPRa) and CRISPR interference (CRISPRi) are two
commonly used types of CRISPR screens, with CRISPRa enhancing the
expression of target genes and CRISPRi blocking it. Combining CRISPR
screens and scRNA-seq, perturb-seq provides a powerful tool for
comprehensively evaluate the influence of CRISPR gene perturbations on
cell states.</p>
<p>In this case study, we applied PhiSpace to a CRISPRa Perturb-seq
dataset from primary human T cells, where over 70 genes were enhanced by
CRISPRa. We leveraged a bulk reference atlas containing detailed
annotations of T cell states to disentangle how individual gene
perturbations influenced the development of T cell states in the
Perturb-seq data.</p>
<p>We used - Reference bulk RNA-seq: <a href="https://www.cell.com/cell/fulltext/S0092-8674(18)31331-X?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS009286741831331X%3Fshowall%3Dtrue" class="external-link">Human
immune bulk RNA-seq data from DICE (Detabase of Immune Cell
Expression)</a> - Query scRNA-seq (Perturb-seq): <a href="https://www.science.org/doi/10.1126/science.abj4008" class="external-link">Schmidt et
al. (2022)</a></p>
<p>Load the packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install latest version of PhiSpace from github</span></span>
<span><span class="co"># suppressMessages(devtools::install_github("jiadongm/PhiSpace/pkg"))</span></span>
<span><span class="co"># Load packages and predefined quantities</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jiadongm.github.io/PhiSpace/">PhiSpace</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/qsbase/qs" class="external-link">qs</a></span><span class="op">)</span><span class="op">)</span> <span class="co"># quick read and write of R objects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/seriation" class="external-link">seriation</a></span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat_dir</span> <span class="op">&lt;-</span> <span class="st">"~/Dropbox/Research_projects/PhiSpace/VignetteData/Perturb-seq/"</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"~/Dropbox/Research_projects/PhiSpace/VignetteData/Perturb-seq/utils.R"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-preparation">Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h2>
<p>Download the processed and query dataset <a href="https://www.dropbox.com/scl/fi/dbryqvqyenxvosv7o9lyk/sceStim.qs?rlkey=zarwoa2gn7cb4g6dltbuk8ddj&amp;st=2eryps2o&amp;dl=0" class="external-link">sceStim.qs</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/sceStim.qs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The DICE bulk reference data can be downloaded via the
<code>celldex</code> package. The sce object from <code>celldex</code>
contains only one assay named <code>logcounts</code>, which contains log
transformed TPM (transcript per million) normalised counts. As raw
counts are not available, we transform <code>logcounts</code> back to
TPM and apply scran normalisation to TPM.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">refPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/ref_sce.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">refPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># BiocManager::install("celldex")</span></span>
<span>  <span class="va">reference</span> <span class="op">&lt;-</span> <span class="fu">celldex</span><span class="fu">::</span><span class="fu">DatabaseImmuneCellExpressionData</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co"># There are duplicated sample names</span></span>
<span>  <span class="va">newSampNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">reference</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">reference</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">reference</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">newSampNames</span></span>
<span>  <span class="co"># Original 'logcounts' were log2(TPM + 1)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">reference</span>, <span class="st">"TPM"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">^</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">reference</span>, <span class="st">"logcounts"</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">reference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>TPM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">reference</span>, <span class="st">"TPM"</span><span class="op">)</span><span class="op">)</span>, colData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">reference</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">reference</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scranTransf.html">scranTransf</a></span><span class="op">(</span><span class="va">reference</span>, <span class="st">"TPM"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">reference</span>, <span class="va">refPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">reference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">refPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-phispace">Run PhiSpace<a class="anchor" aria-label="anchor" href="#run-phispace"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhiResPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/PhiRes.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">PhiAssay</span> <span class="op">&lt;-</span> <span class="st">"logcounts"</span></span>
<span>  <span class="va">PhiRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhiSpaceR_1ref.html">PhiSpaceR_1ref</a></span><span class="op">(</span></span>
<span>    <span class="va">reference</span>, <span class="va">query</span>, phenotypes <span class="op">=</span> <span class="st">"label.fine"</span>,</span>
<span>    PhiSpaceAssay <span class="op">=</span> <span class="va">PhiAssay</span>, regMethod <span class="op">=</span> <span class="st">"PLS"</span>, nfeat <span class="op">=</span> <span class="fl">500</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">PhiRes</span>, <span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">PhiRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">PhiRes</span><span class="op">$</span><span class="va">selectedFeat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2821</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normPhiScores.html">normPhiScores</a></span><span class="op">(</span><span class="va">PhiRes</span><span class="op">$</span><span class="va">PhiSpaceScore</span><span class="op">)</span></span></code></pre></div>
<p>Some cell types in the reference are not T cells. Keep only T cell
types for better interpretation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cTypeRemove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B cells, naive"</span>, <span class="st">"Monocytes, CD14+"</span>, <span class="st">"Monocytes, CD16+"</span>, <span class="st">"NK cells"</span><span class="op">)</span></span>
<span><span class="va">cTypeKeep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span>, <span class="va">cTypeRemove</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"reducedPhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="va">cTypeKeep</span><span class="op">]</span></span></code></pre></div>
<p>First we look at how PhiSpace scores match the original cell cluster
annotation by plotting a heatmap. Columns of the heatmap represent cell
types defined in the reference, and rows are cell clusters defined by
Schmidt et al. (2022). The first thing we notice is that the largest
PhiSpace score is around 0.5 (figure legend), which suggests that the T
cells tended to have uncertain cell types compared to the reference bulk
samples. This is reasonable as most of these cells were CRISPR
perturbed.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht_opt</span><span class="op">$</span><span class="va">message</span> <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="va">queryLvls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1: IFNG High 1"</span>, <span class="st">"2: Negative Regulators"</span>, <span class="st">"3: Th2"</span>, <span class="st">"4: IL22 High"</span>,</span>
<span>               <span class="st">"5: Proliferative (S)"</span>, <span class="st">"6: Proliferative (G2/M)"</span>, <span class="st">"7: TNF Locus High"</span>,</span>
<span>               <span class="st">"8: GNLY High"</span>, <span class="st">"9: CCL3/4 High, IFNG Low"</span>, <span class="st">"10: CD8 Common"</span>,</span>
<span>               <span class="st">"11: EMP1 Guides"</span>, <span class="st">"12: IFNG High 2"</span>, <span class="st">"13: IL2 High 1"</span>,</span>
<span>               <span class="st">"14: CD4 Common"</span>, <span class="st">"15: IL2 High 2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plotPhiSpaceHeatMap.html">plotPhiSpaceHeatMap</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"reducedPhiSpace"</span><span class="op">)</span>, </span>
<span>  queryLabs <span class="op">=</span> <span class="va">query</span><span class="op">$</span><span class="va">cluster_name</span>, </span>
<span>  name <span class="op">=</span> <span class="st">"PhiScore"</span>, queryLvls <span class="op">=</span> <span class="va">queryLvls</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="t-cell-activation">T cell activation<a class="anchor" aria-label="anchor" href="#t-cell-activation"></a>
</h2>
<p>CD4 and CD8 are two of the major T cell populations. Schmidt et
al. (2022) looked at the presence of CD4 and CD8 T cells in their
dataset by using a CD4/CD8 score, taking both positive and negative
values: the higher (lower) the score, the more CD4-(CD8-)like a cell is;
the closer the score to 0, the more ambiguous.</p>
<p>From our PhiSpace scores we define a new CD4/CD8 score as follows.
Since there are multiple CD4 and CD8 subtypes defined in the reference,
we first define the CD4 (CD8) score as the average PhiSpace scores of
all CD4 (CD8) subtypes. Then the new CD4/CD8 score is defined as the
cube root transformation of CD4 score - CD8 score. The new CD4/CD8 score
has the same meaning as the one defined by Schmidt et al. (2022).</p>
<p>The two scores gave very similar visualisation (UMAP) as the
original. Both implied that cells towards the top left (bottom right)
corners were more CD4-(CD8-)like.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Original CD4/CD8 score</span></span>
<span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">query</span><span class="op">$</span><span class="va">CD4.CD8.Score</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-7-1.png" width="480"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># New CD4/CD8 score</span></span>
<span><span class="va">allCellTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">CD4Types</span> <span class="op">&lt;-</span> <span class="va">allCellTypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"CD4"</span>, <span class="va">allCellTypes</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">CD8Types</span> <span class="op">&lt;-</span> <span class="va">allCellTypes</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"CD8"</span>, <span class="va">allCellTypes</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">scCD4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="va">CD4Types</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">scCD8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="va">CD8Types</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">scCD4</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-7-2.png" width="480"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">scCD8</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-7-3.png" width="480"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newCD4Score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sign.html" class="external-link">sign</a></span><span class="op">(</span><span class="va">scCD4</span> <span class="op">-</span> <span class="va">scCD8</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">scCD4</span> <span class="op">-</span> <span class="va">scCD8</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">newCD4Score</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-7-4.png" width="480"></p>
<p>The next thing Schmidt et al. (2022) looked at was how activated the
T cells were. They defined an activation score using T cell activation
markers. Since we have two activated T cell types (activated CD4 and
CD8) in the reference, we simply define a new activation score as the
cube root transform of the sum of activated CD4 and CD8 scores. Again,
these two activation scores gave similar visualisation.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">query</span><span class="op">$</span><span class="va">activation.score</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-8-1.png" width="480"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scActCD4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"T cells, CD4+, naive, stimulated"</span><span class="op">]</span></span>
<span><span class="va">scActCD8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="st">"T cells, CD8+, naive, stimulated"</span><span class="op">]</span></span>
<span><span class="va">scAct</span> <span class="op">&lt;-</span> <span class="va">scActCD4</span> <span class="op">+</span> <span class="va">scActCD8</span> </span>
<span><span class="fu"><a href="../reference/matrixPlot.html">matrixPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"umap_original"</span><span class="op">)</span>, comp_idx <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, colBy <span class="op">=</span> <span class="va">scAct</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-8-2.png" width="480"></p>
<p>An important question in Schmidt et al. (2022) is how individual
CRISPRa perturbations (enhancing gene activities) contribute to T cell
activation. They plotted the T cell activation scores grouped by
individual perturbed genes. Among those perturbed genes, some were
expected to be nagative regulators, i.e. contributing negatively to T
cell activations. Since some cells were not perturbed at all, they were
used as control group and hypothesis testing was used to see if an
individual perturbation significantly promoted or suppressed activation
(p values Bonferroni corrected).</p>
<p>We plotted boxplots for both versions of activation scores. Both
results highlighted some key genes mostly strongly promoted or
suppressed activation, e.g. VAV1 and CD28 (promoting), MUC1 and MAP4K1
(suppressing). However, in our result all negative regulators were found
significantly suppressing activation, whereas in Schmidt et al. (2025)
one negative regulator (IKZF3) was not found significant. We also found
more significant positive regulators than Schmidt et al. (2025).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctrlReg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NO-TARGET"</span><span class="op">)</span></span>
<span><span class="co"># Define positive and negative regulators according to Schmidt et al. (2022)</span></span>
<span><span class="va">negReg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"IKZF3"</span>, <span class="st">"CEACAM1"</span>, <span class="st">"FOXL2NB"</span>, <span class="st">"ARHGDIB"</span>, <span class="st">"ITPKA"</span>, <span class="st">"JMJD1C"</span>, <span class="st">"GRAP"</span>, <span class="st">"INPPL1"</span>, </span>
<span>    <span class="st">"SLA2"</span>, <span class="st">"LAT2"</span>, <span class="st">"MAP4K1"</span>, <span class="st">"MUC1"</span>, <span class="st">"GATA3"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">perturbActPlot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scAct</span>, <span class="va">xcoord</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sc <span class="op">=</span> <span class="va">scAct</span>, target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pvals_adj</span> <span class="op">&lt;-</span> <span class="fu">tempPvals</span><span class="op">(</span><span class="va">scAct</span><span class="op">)</span><span class="op">$</span><span class="va">pvals</span></span>
<span>  <span class="va">pvals_ast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>pvals_adj <span class="op">=</span> <span class="va">pvals_adj</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      signif <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.001</span> <span class="op">~</span> <span class="st">"***"</span>,</span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.01</span> <span class="op">~</span> <span class="st">"**"</span>,</span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">~</span> <span class="st">"*"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pvals_ast</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">types</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Positive Regulator"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">types</span><span class="op">[</span><span class="va">plot_df</span><span class="op">$</span><span class="va">target</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">negReg</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Negative Regulator"</span></span>
<span>  <span class="va">types</span><span class="op">[</span><span class="va">plot_df</span><span class="op">$</span><span class="va">target</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">ctrlReg</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Control"</span></span>
<span>  <span class="va">plot_df</span><span class="op">$</span><span class="va">types</span> <span class="op">&lt;-</span> <span class="va">types</span></span>
<span>  </span>
<span>  <span class="va">targetMed</span> <span class="op">&lt;-</span> <span class="va">plot_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">med</span><span class="op">)</span></span>
<span>  <span class="va">plot_df</span><span class="op">$</span><span class="va">targetOrdered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">$</span><span class="va">target</span>, levels <span class="op">=</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">target</span><span class="op">)</span></span>
<span>  <span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span>, levels <span class="op">=</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">target</span><span class="op">)</span> </span>
<span>  <span class="va">medCtrl</span> <span class="op">&lt;-</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">med</span><span class="op">[</span><span class="va">targetMed</span><span class="op">$</span><span class="va">target</span> <span class="op">==</span> <span class="st">"NO-TARGET"</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">typeCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span> <span class="op">=</span> <span class="st">"gray"</span>, <span class="st">"Positive Regulator"</span> <span class="op">=</span> <span class="st">"red"</span>, <span class="st">"Negative Regulator"</span> <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span>  <span class="va">plot_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">sc</span>, <span class="va">targetOrdered</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">types</span><span class="op">)</span>, outliers <span class="op">=</span> <span class="cn">F</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">typeCols</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pvals_ast</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">xcoord</span>, <span class="va">target</span>, label <span class="op">=</span> <span class="va">signif</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">medCtrl</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">scAct</span> <span class="op">&lt;-</span> <span class="va">query</span><span class="op">$</span><span class="va">activation.score</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">perturbActPlot</span><span class="op">(</span><span class="va">scAct</span>, <span class="fl">650</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Activation scores (Schmidt et al., 2022) by perturbed genes"</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scAct</span> <span class="op">&lt;-</span> <span class="va">scActCD4</span> <span class="op">+</span> <span class="va">scActCD8</span></span>
<span><span class="fu">perturbActPlot</span><span class="op">(</span><span class="va">scAct</span>, <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Activation scores (PhiSpace) by perturbed genes"</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-9-2.png" width="672"></p>
<p>In addition to recapitulate what was found by Schmidt et al. (2022),
PhiSpace provides flexibility for more analyses on how perturbations
affects T cell states. We can group any cell type scores by perturbed
genes, thus assessing how these perturbations affected T cell states.
For example, boxes plots for Th1 and Th2 (T helper 1 and T helper 2)
scores highlighted TBX21 and GATA3, which were known as key genes in the
Th1 and Th2 cell fates (<a href="https://www.cell.com/immunity/fulltext/S1074-7613(22)00128-5?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS1074761322001285%3Fshowall%3Dtrue" class="external-link">role
of TBX21</a> and <a href="https://www.nature.com/articles/nri2476" class="external-link">role
of GATA3</a>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"reducedPhiSpace"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "T cells, CD4+, memory TREG"       "T cells, CD4+, naive"            </span></span>
<span><span class="co">##  [3] "T cells, CD4+, naive, stimulated" "T cells, CD4+, naive TREG"       </span></span>
<span><span class="co">##  [5] "T cells, CD4+, TFH"               "T cells, CD4+, Th1"              </span></span>
<span><span class="co">##  [7] "T cells, CD4+, Th1_17"            "T cells, CD4+, Th17"             </span></span>
<span><span class="co">##  [9] "T cells, CD4+, Th2"               "T cells, CD8+, naive"            </span></span>
<span><span class="co">## [11] "T cells, CD8+, naive, stimulated"</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tempcTypeBoxplot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cType</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span>,<span class="va">cType</span><span class="op">]</span></span>
<span>  <span class="va">pvals_adj</span> <span class="op">&lt;-</span> <span class="fu">tempPvals</span><span class="op">(</span><span class="va">sc</span><span class="op">)</span><span class="op">$</span><span class="va">pvals_adj</span></span>
<span>  <span class="va">pvals_ast</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>pvals_adj <span class="op">=</span> <span class="va">pvals_adj</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      signif <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.001</span> <span class="op">~</span> <span class="st">"***"</span>,</span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.01</span> <span class="op">~</span> <span class="st">"**"</span>,</span>
<span>        <span class="va">pvals_adj</span> <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="op">~</span> <span class="st">"*"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pvals_ast</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sc <span class="op">=</span> <span class="va">sc</span>, target <span class="op">=</span> <span class="va">query</span><span class="op">$</span><span class="va">gene</span><span class="op">)</span></span>
<span>  <span class="va">plot_df</span><span class="op">$</span><span class="va">cellID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">targetMed</span> <span class="op">&lt;-</span> <span class="va">plot_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>med <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">med</span><span class="op">)</span></span>
<span>  <span class="va">plot_df</span><span class="op">$</span><span class="va">targetOrdered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">plot_df</span><span class="op">$</span><span class="va">target</span>, levels <span class="op">=</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">target</span><span class="op">)</span> </span>
<span>  <span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">plot_df</span>, <span class="va">targetMed</span>, by <span class="op">=</span> <span class="st">"target"</span><span class="op">)</span></span>
<span>  <span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">pvals_ast</span><span class="op">$</span><span class="va">target</span>, levels <span class="op">=</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">target</span><span class="op">)</span> </span>
<span>  <span class="va">medCtrl</span> <span class="op">&lt;-</span> <span class="va">targetMed</span><span class="op">$</span><span class="va">med</span><span class="op">[</span><span class="va">targetMed</span><span class="op">$</span><span class="va">target</span> <span class="op">==</span> <span class="st">"NO-TARGET"</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">plot_df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">sc</span>, <span class="va">targetOrdered</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">med</span><span class="op">)</span>, outliers <span class="op">=</span> <span class="cn">F</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">pvals_ast</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">sc</span>,<span class="fl">0.999</span><span class="op">)</span>, <span class="va">target</span>, label <span class="op">=</span> <span class="va">signif</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span></span>
<span>    <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>low <span class="op">=</span> <span class="st">"blue"</span>, mid <span class="op">=</span> <span class="st">"white"</span>, high <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">medCtrl</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">p</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">tempcTypeBoxplot</span><span class="op">(</span><span class="st">"T cells, CD4+, Th1"</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tempcTypeBoxplot</span><span class="op">(</span><span class="st">"T cells, CD4+, Th2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="PerturbSeq_files/figure-html/unnamed-chunk-10-2.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/jiadongm" class="external-link">Jiadong Mao</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
