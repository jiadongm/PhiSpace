<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CosMx: discovery of divergent cell states in lung cancer microenvironment • PhiSpace</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="CosMx: discovery of divergent cell states in lung cancer microenvironment">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PhiSpace</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>CosMx: discovery of divergent cell states in
lung cancer microenvironment</h1>
                        <h4 data-toc-skip class="author">Jiadong
Mao</h4>
            
            <h4 data-toc-skip class="date">2025-04-29</h4>
      

      <div class="hidden name"><code>CosMx.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="highlights">Highlights<a class="anchor" aria-label="anchor" href="#highlights"></a>
</h3>
<ul>
<li><p>Annotation using multiple references;</p></li>
<li><p>Healthy reference annotates cancerous query;</p></li>
<li><p>Discovery of spatial niches with diverse cell states.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this case study, we will apply PhiSpace to drive cell state
discovery in lung cancer microenvironment:</p>
<ul>
<li>Query: CosMx dataset consisting of samples from non-small cell lung
cancer (NSCLC) patients (<a href="https://www.nature.com/articles/s41587-022-01483-z" class="external-link">He et al.,
2022</a>).</li>
<li>Reference: 4 scRNA-seq datasets from healthy and fibrotic lungs (<a href="https://www.nature.com/articles/s41588-024-01702-0" class="external-link">Natri et al.,
2024</a>).</li>
</ul>
<p>Nanotring CosMx is a subcellular spatial transcriptomics (ST)
platform. It’s imaging-based and reaches single-molecule resolution,
i.e. it produces a long list of mRNA molecules, their corresponding
genes and spatial coordinates. Since single-molecules are difficult to
analyse directly, we need some level of aggregation. Here since the cell
segmentation was available, we aggregated transcripts within each
segmented cell. PhiSpace doens’t require cell segmentation to be
accurate – it just treats the segmented cells as some form of
mini-bulk.</p>
<p>For this case study, we have defined some util functions, which can
be downloaded <a href="https://www.dropbox.com/scl/fi/zi12ovivk9ys0b8pk4t0t/CosMx_utils.R?rlkey=s902bst1wz3pkuwhsi7v6gqdq&amp;st=82q6h5pc&amp;dl=0" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Name of the game</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jiadongm.github.io/PhiSpace/">PhiSpace</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Tidyverse packages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Other utils</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/qsbase/qs" class="external-link">qs</a></span><span class="op">)</span><span class="op">)</span> <span class="co"># Fast read and write of large R objects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span><span class="op">)</span> <span class="co"># Heatmap</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/seriation" class="external-link">seriation</a></span><span class="op">)</span><span class="op">)</span> <span class="co"># Seriation method for clustering rows and columns of heatmap</span></span>
<span></span>
<span><span class="va">dat_dir</span> <span class="op">&lt;-</span> <span class="st">"~/Dropbox/Research_projects/PhiSpace/VignetteData/CosMx/"</span> <span class="co"># replace this by your own directory</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"CosMx_utils.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="single-sample-analysis">Single-sample analysis<a class="anchor" aria-label="anchor" href="#single-sample-analysis"></a>
</h2>
<div class="section level3">
<h3 id="data-prepration">Data prepration<a class="anchor" aria-label="anchor" href="#data-prepration"></a>
</h3>
<p>Load the four reference datasets, which have already been processed
and downsampled into sce objects, each contain cells from a lineage
(immune, epithelilal, endothelial or mesenchymal). Download thse sce
objects from <a href="https://www.dropbox.com/scl/fo/7wvz9y8871sgx8u9rxtan/ALd0xPKl3jLgc4-aXJKUSS4?rlkey=vn7s0iqp7n4ni0qi1e73dhoen&amp;st=a8gx9sp5&amp;dl=0" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"immune"</span>, <span class="st">"epithelial"</span>, <span class="st">"endothelial"</span>, <span class="st">"mesenchymal"</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">lineage</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/LungFibrosis/"</span>, <span class="va">lineage</span>, <span class="st">"_sce.qs"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ref_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"immu"</span>, <span class="st">"epi"</span>, <span class="st">"endo"</span>, <span class="st">"mesen"</span><span class="op">)</span></span></code></pre></div>
<p>Lung samples in the query dataset are named Lungx_Repx, denoting lung
(patient) and biological replicate. We first showcase the annotation
performance of PhiSpace using one particular lung sample Lung5_Rep1,
which can be downloaded <a href="https://www.dropbox.com/scl/fi/nzs9kynj4wj3a096ojx4a/Lung5_Rep1_SCE.qs?rlkey=adiyctqb8onbk1s1ubhxp04ua&amp;st=a04p03rf&amp;dl=0" class="external-link">here</a>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">YtrainName</span> <span class="op">&lt;-</span> <span class="st">"manual_annotation_1"</span></span>
<span><span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="st">"Lung5_Rep1"</span></span>
<span><span class="va">qs_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/CosMx_lung/"</span>, <span class="va">tissueName</span>, <span class="st">"_SCE.qs"</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">qs_dir</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/zeroFeatQC.html">zeroFeatQC</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## All features have at least 1 nonzero value.</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logTransf.html">logTransf</a></span><span class="op">(</span><span class="va">query</span>, use_log1p <span class="op">=</span> <span class="cn">TRUE</span>, targetAssay <span class="op">=</span> <span class="st">"log1p"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-phispace">Run PhiSpace<a class="anchor" aria-label="anchor" href="#run-phispace"></a>
</h3>
<p>Run PhiSpace using 4 references.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhiAssay</span> <span class="op">&lt;-</span> <span class="st">"log1p"</span></span>
<span><span class="va">PhiResPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/CosMxLung5Rep1PhiRes4Refs.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">sc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ref_list</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sc_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ref_list</span><span class="op">)</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ref_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Define reference dataset and normalise</span></span>
<span>    <span class="va">lineage</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ref_list</span><span class="op">)</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span></span>
<span>    <span class="va">reference</span> <span class="op">&lt;-</span> <span class="va">ref_list</span><span class="op">[[</span><span class="va">lineage</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">reference</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logTransf.html">logTransf</a></span><span class="op">(</span><span class="va">reference</span>, targetAssay <span class="op">=</span> <span class="va">PhiAssay</span>, use_log1p <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>    <span class="co"># Run PhiSpace</span></span>
<span>    <span class="va">PhiRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhiSpaceR_1ref.html">PhiSpaceR_1ref</a></span><span class="op">(</span></span>
<span>      <span class="va">reference</span>, <span class="va">query</span>, </span>
<span>      phenotypes <span class="op">=</span> <span class="va">YtrainName</span>, PhiSpaceAssay <span class="op">=</span> <span class="st">"log1p"</span>,</span>
<span>      regMethod <span class="op">=</span> <span class="st">"PLS"</span>, center <span class="op">=</span> <span class="cn">T</span>, scale <span class="op">=</span> <span class="cn">F</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># Extract cell type scores and rename cell types by adding lineage info</span></span>
<span>    <span class="va">sc</span> <span class="op">&lt;-</span> <span class="va">PhiRes</span><span class="op">$</span><span class="va">PhiSpaceScore</span></span>
<span>    <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normPhiScores.html">normPhiScores</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span>, <span class="st">"("</span>, <span class="va">lineage</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>    <span class="va">sc_list</span><span class="op">[[</span><span class="va">lineage</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sc</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">sc_list</span>, <span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">sc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Concatenate annotations from 4 references into one and simplify cell
type names.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cbindSc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">sc_list</span><span class="op">)</span></span>
<span><span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cbindSc</span><span class="op">)</span></span>
<span><span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"immune"</span>, <span class="st">"immu"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span><span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"epithelial"</span>, <span class="st">"epi"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span><span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"endothelial"</span>, <span class="st">"endo"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span><span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"mesenchymal"</span>, <span class="st">"mesen"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cbindSc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scNames</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cbindSc</span> </span>
<span><span class="va">originalNames</span> <span class="op">&lt;-</span> <span class="va">simpleNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simpleNames</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">12</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">23</span>, <span class="fl">24</span>, <span class="fl">25</span>, <span class="fl">26</span>, <span class="fl">43</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"MoMacroph(immu)"</span>, <span class="st">"InflamMono(immu)"</span>,  <span class="st">"AlveolarMacroph(immu)"</span>,</span>
<span>  <span class="st">"ProlifImm(immu)"</span>, <span class="st">"InterstMacroph(immu)"</span>, <span class="st">"ProlifEpi(epi)"</span>,</span>
<span>  <span class="st">"SecretSCGB3A2+(epi)"</span>, <span class="st">"TransAT2(epi)"</span>, <span class="st">"SecretSCGB1A1+/MUC5B+(epi)"</span>,</span>
<span>  <span class="st">"SecretSCGB1A1+/SCGB3A2+(epi)"</span>, <span class="st">"DiffCiliated(epi)"</span>, <span class="st">"MyoFB Act(mesen)"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Double check if the renaming was correctly done</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">originalNames</span>, <span class="va">simpleNames</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       originalNames                        simpleNames                   </span></span>
<span><span class="co">##  [1,] "Monocyte(immu)"                     "Monocyte(immu)"              </span></span>
<span><span class="co">##  [2,] "Monocyte-derived macrophage(immu)"  "MoMacroph(immu)"             </span></span>
<span><span class="co">##  [3,] "NK(immu)"                           "NK(immu)"                    </span></span>
<span><span class="co">##  [4,] "Inflammatory monocyte(immu)"        "InflamMono(immu)"            </span></span>
<span><span class="co">##  [5,] "moDC(immu)"                         "moDC(immu)"                  </span></span>
<span><span class="co">##  [6,] "B cells(immu)"                      "B cells(immu)"               </span></span>
<span><span class="co">##  [7,] "cDC1(immu)"                         "cDC1(immu)"                  </span></span>
<span><span class="co">##  [8,] "cDC2(immu)"                         "cDC2(immu)"                  </span></span>
<span><span class="co">##  [9,] "Alveolar macrophage(immu)"          "AlveolarMacroph(immu)"       </span></span>
<span><span class="co">## [10,] "Proliferating - Imm(immu)"          "ProlifImm(immu)"             </span></span>
<span><span class="co">## [11,] "Plasma(immu)"                       "Plasma(immu)"                </span></span>
<span><span class="co">## [12,] "Interstitial macrophage(immu)"      "InterstMacroph(immu)"        </span></span>
<span><span class="co">## [13,] "CD4(immu)"                          "CD4(immu)"                   </span></span>
<span><span class="co">## [14,] "Mast(immu)"                         "Mast(immu)"                  </span></span>
<span><span class="co">## [15,] "CD8/NKT(immu)"                      "CD8/NKT(immu)"               </span></span>
<span><span class="co">## [16,] "pDC(immu)"                          "pDC(immu)"                   </span></span>
<span><span class="co">## [17,] "AT2(epi)"                           "AT2(epi)"                    </span></span>
<span><span class="co">## [18,] "Proliferating - Epi(epi)"           "ProlifEpi(epi)"              </span></span>
<span><span class="co">## [19,] "Ciliated(epi)"                      "Ciliated(epi)"               </span></span>
<span><span class="co">## [20,] "AT1(epi)"                           "AT1(epi)"                    </span></span>
<span><span class="co">## [21,] "Secretory - SCGB3A2+(epi)"          "SecretSCGB3A2+(epi)"         </span></span>
<span><span class="co">## [22,] "Basal(epi)"                         "Basal(epi)"                  </span></span>
<span><span class="co">## [23,] "Transitional AT2(epi)"              "TransAT2(epi)"               </span></span>
<span><span class="co">## [24,] "Secretory - SCGB1A1+/MUC5B+(epi)"   "SecretSCGB1A1+/MUC5B+(epi)"  </span></span>
<span><span class="co">## [25,] "Secretory - SCGB1A1+/SCGB3A2+(epi)" "SecretSCGB1A1+/SCGB3A2+(epi)"</span></span>
<span><span class="co">## [26,] "Differentiating ciliated(epi)"      "DiffCiliated(epi)"           </span></span>
<span><span class="co">## [27,] "KRT5-/KRT17+(epi)"                  "KRT5-/KRT17+(epi)"           </span></span>
<span><span class="co">## [28,] "PNEC(epi)"                          "PNEC(epi)"                   </span></span>
<span><span class="co">## [29,] "Venule(endo)"                       "Venule(endo)"                </span></span>
<span><span class="co">## [30,] "Arteriole(endo)"                    "Arteriole(endo)"             </span></span>
<span><span class="co">## [31,] "Lymphatic(endo)"                    "Lymphatic(endo)"             </span></span>
<span><span class="co">## [32,] "Systemic venous(endo)"              "Systemic venous(endo)"       </span></span>
<span><span class="co">## [33,] "aCap(endo)"                         "aCap(endo)"                  </span></span>
<span><span class="co">## [34,] "gCap(endo)"                         "gCap(endo)"                  </span></span>
<span><span class="co">## [35,] "Inflamed(endo)"                     "Inflamed(endo)"              </span></span>
<span><span class="co">## [36,] "PLIN2+ FB(mesen)"                   "PLIN2+ FB(mesen)"            </span></span>
<span><span class="co">## [37,] "MyoFB(mesen)"                       "MyoFB(mesen)"                </span></span>
<span><span class="co">## [38,] "Adventitial FB(mesen)"              "Adventitial FB(mesen)"       </span></span>
<span><span class="co">## [39,] "Alveolar FB(mesen)"                 "Alveolar FB(mesen)"          </span></span>
<span><span class="co">## [40,] "SMC(mesen)"                         "SMC(mesen)"                  </span></span>
<span><span class="co">## [41,] "Pericyte(mesen)"                    "Pericyte(mesen)"             </span></span>
<span><span class="co">## [42,] "Mesothelial(mesen)"                 "Mesothelial(mesen)"          </span></span>
<span><span class="co">## [43,] "MyoFB - Activated(mesen)"           "MyoFB Act(mesen)"</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">simpleNames</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="analyses">Analyses<a class="anchor" aria-label="anchor" href="#analyses"></a>
</h3>
<p>First we visualise the spatial distribution of some cell types. The
first plot shows spatial domains (called ‘niche’ in metadata) defined by
He et al. (2022). It shows a typical lung cancer microenvironment, where
we have tumour surounded by normal stroma with ‘islands’ of immune cells
forming tertiary lymphoid structure.</p>
<p>Next we plot transitional alvelolar type 2 cells (TransAT2). This is
a type of lung stem cells and a possible orgin of lung ardenocarcinoma
(LUAD). As we can see the tumour region showed strong TransAT2 identity,
which probably reflected LUAD’s origin. Interestingly, the tumour region
also exhibited very strong mesothelial cell identity. Mesothelial is
usually not the cell type giving rise to LUAD, but the presence of this
cell type identity might reflect the so-called epithelial-to-mesenchymal
transition (EMT). EMT allows the tumour cells originated from epithelial
cells to lose their epithelial characteristics (e.g. cell-cell adhesion)
and be ready for metastasis. We then visualised the distribution of AT2
cells, which was scattered in stromal region but not in tumour region.
This emphasises that the AT2 identity we previouly saw in tumour region
is really transitonal instead of non-transitional.</p>
<p>Lastly we plotted two common types of immune cells, CD4 T and B
cells. Their territories overlapped a lot and both tended to form
island-like lymphoid structures. This makes perfect sense as we know
that T and B cells are very common in these lymphoid structures.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, groupBy <span class="op">=</span> <span class="st">"niche"</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, legend.symb.size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">nicheCol</span><span class="op">)</span> </span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"TransAT2(epi)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, reOrder <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"Mesothelial(mesen)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, reOrder <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-3.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"AT2(epi)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, reOrder <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-4.png" width="700"></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"CD4(immu)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, reOrder <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-5.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"B cells(immu)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, legend.position <span class="op">=</span> <span class="st">"top"</span>, reOrder <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-6-6.png" width="700"></p>
<p>It is very encouraging to see how a simple spatial heatmap can alreay
be so informative. Since the distribution of different cell types show
such diverse spatial distributions, why can’t we use them to define
spatial niches? Here we simply cluster the PhiSpace cell type scores
into 9 clusters to match the number of spatial domains defined by He et
al. (2022). As we see below, these clusters correspond well to the
domains defined by He et al. (2022), but with more subtlety. In
particular, our PhiSpace clustering seemed to idnetify two niches within
the ‘tumour interior’ domain of He et al. (2022).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clustResPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/Lung5_Rep1_PhiClusts4Refs.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">clustResPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">PhiPCRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getPC.html">getPC</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span>, ncomp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">PhiPCRes</span><span class="op">$</span><span class="va">accuProps</span><span class="op">)</span></span>
<span>  <span class="va">mat2clust</span> <span class="op">&lt;-</span> <span class="va">PhiPCRes</span><span class="op">$</span><span class="va">scores</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">25</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">94863</span><span class="op">)</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span></span>
<span>    <span class="va">mat2clust</span>, centers <span class="op">=</span> <span class="fl">9</span>, iter.max <span class="op">=</span> <span class="fl">200L</span>, nstart <span class="op">=</span> <span class="fl">50</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">clust_res</span>, <span class="va">clustResPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">clustResPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">query</span><span class="op">$</span><span class="va">PhiClust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">clust_res</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="va">tempClustCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"1"</span> <span class="op">=</span> <span class="st">"#FF7F00"</span>, <span class="st">"2"</span> <span class="op">=</span> <span class="st">"#33A02C"</span>, <span class="st">"3"</span> <span class="op">=</span> <span class="st">"#B15928"</span>, <span class="st">"4"</span> <span class="op">=</span> <span class="st">"#1F78B4"</span>, </span>
<span>  <span class="st">"5"</span> <span class="op">=</span> <span class="st">"gray50"</span>, <span class="st">"6"</span> <span class="op">=</span> <span class="st">"#A6CEE3"</span> , <span class="st">"7"</span> <span class="op">=</span>  <span class="st">"#6A3D9A"</span>, <span class="st">"8"</span> <span class="op">=</span>  <span class="st">"#FFFF99"</span>, <span class="st">"9"</span> <span class="op">=</span> <span class="st">"black"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span></span>
<span>  <span class="va">query</span>, x_coord <span class="op">=</span> <span class="st">"sdimx"</span>, y_coord <span class="op">=</span> <span class="st">"sdimy"</span>, groupBy <span class="op">=</span> <span class="st">"PhiClust"</span>, ptSize <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">tempClustCols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span></span>
<span>      override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"top"</span>,</span>
<span>    legend.key.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">""</span><span class="op">)</span> </span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Comparison of spatial domains defined by He et al. (2022) and spatial niches defined by PhiSpace</span></span>
<span><span class="va">nicheClust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">niche</span>, <span class="va">query</span><span class="op">$</span><span class="va">PhiClust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">t</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nicheClust</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">nicheClust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span></span>
<span>  <span class="op">!</span> <span class="va">cluster</span>, names_to <span class="op">=</span> <span class="st">"niche"</span>, values_to <span class="op">=</span> <span class="st">"counts"</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">cluster</span>, x <span class="op">=</span> <span class="va">counts</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">niche</span><span class="op">)</span>, position <span class="op">=</span> <span class="st">"fill"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">nicheCol</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"PhiSpace clusters"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Proportions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<p>It turns out that our clustering split the ‘tumour interior’ domain
of He et al. (2022) into two niches with different <em>cell type
divergence</em>. The motivation for defining cell type divergence is
that some tissue entities such as tumour and lymphoid structure tend to
show a higher divergence of cell types. This is because tumour is
usually transcriptionally more active compared to normal tissue (these
rebel cells are busy surviving!); lymphoid sturctures are packed with
crowds of small immune cells. How do we measure divergence? With
PhiSpace it’s easy. We simply compute, within each cell-like object (in
this case segmented cell), the 75% quantile of all PhiSpace cell type
scores. This is because if a cell-like object has a range of different
cell type identities, then it should also have a higher 75% quantile of
scores. (This definition is actually inspired by <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5798764/" class="external-link">RLE plot</a>
developed by our wonderful WEHI colleagues, which is used in a
completely different context but based on the same principle.)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span><span class="op">$</span><span class="va">divergence</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">quantile</span>, prob <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span></span>
<span>  <span class="va">query</span>, <span class="st">"sdimx"</span>, <span class="st">"sdimy"</span>, ptSize <span class="op">=</span> <span class="fl">0.5</span>, groupBy <span class="op">=</span> <span class="st">"divergence"</span>, reOrder <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_steps.html" class="external-link">scale_colour_stepsn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">PhiSpace</span><span class="fu">:::</span><span class="va">MATLAB_cols</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Scale for <span style="color: #00BB00;">colour</span> is already present.</span></span>
<span><span class="co">## Adding another scale for <span style="color: #00BB00;">colour</span>, which will replace the existing scale.</span></span></code></pre>
<p><img src="CosMx_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Next we visualise the PhiSpace-niche-specific cell type divergence.
Recall that niches 5 and 9 are both located in the ‘tumour interior’
domain. Here we can see that these two niches have very different cell
type divergence. For more analysis along this line see our <a href="https://www.biorxiv.org/content/10.1101/2025.02.05.636735v1" class="external-link">PhiSpace
ST paper</a>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span><span class="op">@</span><span class="va">colData</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">PhiClust</span>, x <span class="op">=</span> <span class="va">divergence</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">PhiClust</span><span class="op">)</span>, outlier.size <span class="op">=</span> <span class="fl">0.5</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span>, outlier.stroke <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">tempClustCols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"PhiSpace Niches"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Divergence"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="multi-sample-analysis">Multi-sample analysis<a class="anchor" aria-label="anchor" href="#multi-sample-analysis"></a>
</h2>
<p>After focusing on a particular lung cancer sample, now we use
PhiSpace to do a multi-sample analysis, using all lung cancer samples in
the CosMx dataset.</p>
<p>Load all query lung samples, which can be downloaded <a href="https://www.dropbox.com/scl/fo/p8zg76jdysuqtx4t2lm0e/AERmTZE4wLD9Uyg_AEMDNLQ?rlkey=o8hcksuvhs6ymv1zt3jvu8xnn&amp;st=bl89z34f&amp;dl=0" class="external-link">here</a>.
Also load the precomputed <a href="https://www.dropbox.com/scl/fi/qy3m2co5npmucm2tj406k/CosMxAllLungsPhiRes4Refs.qs?rlkey=hefck049m8isu9utpzcp630ot&amp;st=y0p4kvhk&amp;dl=0" class="external-link">PhiSpace
annotation results</a> to save RAM.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tissueNames</span> <span class="op">&lt;-</span> <span class="va">tissueNames_CosMx</span></span>
<span><span class="va">query_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span></span>
<span><span class="va">PhiResPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/CosMxAllLungsPhiRes4Refs.qs"</span><span class="op">)</span></span>
<span><span class="va">sc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="va">tissueNames</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span></span>
<span>  <span class="va">qs_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/CosMx_lung/"</span>, <span class="va">tissueName</span>, <span class="st">"_SCE.qs"</span><span class="op">)</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">qs_dir</span><span class="op">)</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/zeroFeatQC.html">zeroFeatQC</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logTransf.html">logTransf</a></span><span class="op">(</span><span class="va">query</span>, use_log1p <span class="op">=</span> <span class="cn">TRUE</span>, targetAssay <span class="op">=</span> <span class="st">"log1p"</span><span class="op">)</span></span>
<span>  <span class="va">sc4Refs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sc_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[[</span><span class="va">tissueName</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">cbindSc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">sc4Refs</span><span class="op">)</span></span>
<span>  <span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cbindSc</span><span class="op">)</span></span>
<span>  <span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"immune"</span>, <span class="st">"immu"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span>  <span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"epithelial"</span>, <span class="st">"epi"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span>  <span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"endothelial"</span>, <span class="st">"endo"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span>  <span class="va">scNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"mesenchymal"</span>, <span class="st">"mesen"</span>, <span class="va">scNames</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cbindSc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">scNames</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">cbindSc</span> </span>
<span>  <span class="va">query_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">query</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.All features have at least 1 nonzero value.</span></span></code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">originalNames</span> <span class="op">&lt;-</span> <span class="va">simpleNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simpleNames</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">9</span>, <span class="fl">10</span>, <span class="fl">12</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">23</span>, <span class="fl">24</span>, <span class="fl">25</span>, <span class="fl">26</span>, <span class="fl">43</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"MoMacroph(immu)"</span>, <span class="st">"InflamMono(immu)"</span>,  <span class="st">"AlveolarMacroph(immu)"</span>,</span>
<span>  <span class="st">"ProlifImm(immu)"</span>, <span class="st">"InterstMacroph(immu)"</span>, <span class="st">"ProlifEpi(epi)"</span>,</span>
<span>  <span class="st">"SecretSCGB3A2+(epi)"</span>, <span class="st">"TransAT2(epi)"</span>, <span class="st">"SecretSCGB1A1+/MUC5B+(epi)"</span>,</span>
<span>  <span class="st">"SecretSCGB1A1+/SCGB3A2+(epi)"</span>, <span class="st">"DiffCiliated(epi)"</span>, <span class="st">"MyoFB Act(mesen)"</span></span>
<span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">query_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">query_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">simpleNames</span></span>
<span>  <span class="va">query_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">query</span> </span>
<span><span class="op">}</span></span></code></pre></div>
<p>We use PLSDA (partial least squares discriminant analysis) to
identify cell types that are most enriched in different spatial niches
within different samples. This allows us to compare tumour heterogeneity
across samples.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tumourSig</span> <span class="op">&lt;-</span> <span class="va">tumourSig_indiv</span>  <span class="op">&lt;-</span> <span class="va">regCoef_list</span> <span class="op">&lt;-</span> <span class="va">regCoefIndiv_list</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="va">tissueNames</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">query_list</span><span class="op">[[</span><span class="va">tissueName</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/codeY.html">codeY</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"niche"</span><span class="op">)</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDims</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">[[</span><span class="st">"PhiSpace"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">ncomp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">Y</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>  <span class="va">pls_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvr.html">mvr</a></span><span class="op">(</span><span class="va">X</span>, <span class="va">Y</span>, ncomp <span class="op">=</span> <span class="va">ncomp</span>, method <span class="op">=</span> <span class="st">"PLS"</span><span class="op">)</span></span>
<span>  <span class="va">regCoef</span> <span class="op">&lt;-</span> <span class="va">pls_res</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span>,,<span class="va">ncomp</span><span class="op">]</span></span>
<span>  <span class="va">regCoef_list</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">regCoef</span></span>
<span>  <span class="va">selectedPheno</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/selectFeat.html">selectFeat</a></span><span class="op">(</span><span class="va">regCoef</span>, nfeat <span class="op">=</span> <span class="fl">5</span>, absVal <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span>  <span class="va">tumourSig</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">selectedPheno</span><span class="op">$</span><span class="va">orderedFeatMat</span><span class="op">[</span>,<span class="st">"tumor interior"</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Top five enriched cell types in different tumours. The results make a
lot of sense. First we see that the cell states of tumours from
biological replicates (e.g. Lung5_Rep1, Lung5_Rep2, Lung5_Rep3) are very
similar. But tumour cell states from different patients tend to be more
different. See our <a href="https://www.biorxiv.org/content/10.1101/2025.02.05.636735v1" class="external-link">PhiSpace
ST paper</a> for more detailed analysis on this result.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tumTab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="va">tumourSig</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,<span class="op">]</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">tumTab</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="13%">
<col width="13%">
<col width="13%">
<col width="8%">
<col width="10%">
<col width="11%">
<col width="13%">
<col width="13%">
</colgroup>
<thead><tr class="header">
<th align="left">Lung5_Rep1</th>
<th align="left">Lung5_Rep2</th>
<th align="left">Lung5_Rep3</th>
<th align="left">Lung6</th>
<th align="left">Lung9_Rep1</th>
<th align="left">Lung9_Rep2</th>
<th align="left">Lung12</th>
<th align="left">Lung13</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Mesothelial(mesen)</td>
<td align="left">Mesothelial(mesen)</td>
<td align="left">Mesothelial(mesen)</td>
<td align="left">Basal(epi)</td>
<td align="left">Mesothelial(mesen)</td>
<td align="left">Mesothelial(mesen)</td>
<td align="left">Adventitial FB(mesen)</td>
<td align="left">Mesothelial(mesen)</td>
</tr>
<tr class="even">
<td align="left">Basal(epi)</td>
<td align="left">SecretSCGB1A1+/MUC5B+(epi)</td>
<td align="left">Basal(epi)</td>
<td align="left">MyoFB Act(mesen)</td>
<td align="left">Mast(immu)</td>
<td align="left">CD4(immu)</td>
<td align="left">Mesothelial(mesen)</td>
<td align="left">MoMacroph(immu)</td>
</tr>
<tr class="odd">
<td align="left">SecretSCGB1A1+/MUC5B+(epi)</td>
<td align="left">Basal(epi)</td>
<td align="left">SecretSCGB3A2+(epi)</td>
<td align="left">MyoFB(mesen)</td>
<td align="left">InterstMacroph(immu)</td>
<td align="left">Mast(immu)</td>
<td align="left">SecretSCGB1A1+/MUC5B+(epi)</td>
<td align="left">AlveolarMacroph(immu)</td>
</tr>
<tr class="even">
<td align="left">SecretSCGB3A2+(epi)</td>
<td align="left">SecretSCGB3A2+(epi)</td>
<td align="left">SecretSCGB1A1+/MUC5B+(epi)</td>
<td align="left">PNEC(epi)</td>
<td align="left">CD4(immu)</td>
<td align="left">Systemic venous(endo)</td>
<td align="left">AlveolarMacroph(immu)</td>
<td align="left">SecretSCGB1A1+/MUC5B+(epi)</td>
</tr>
<tr class="odd">
<td align="left">AlveolarMacroph(immu)</td>
<td align="left">TransAT2(epi)</td>
<td align="left">Adventitial FB(mesen)</td>
<td align="left">Mast(immu)</td>
<td align="left">Arteriole(endo)</td>
<td align="left">Lymphatic(endo)</td>
<td align="left">aCap(endo)</td>
<td align="left">Lymphatic(endo)</td>
</tr>
</tbody>
</table>
<p>As in the Visium case study, we compute co-presence matrices to
summarise how different cell types tend to co-present at the same
spatial location. Different from the Visium case study, since we have
consistent annotation of spatial domains, this time we compute
domain-specific cell type co-presence matrices, instead of
sample-specific matrices as in Visium case.</p>
<p>First we visualise the cell type co-presence matrix of tumour
interior niche of Lung5_Rep1 as an example. We sampled 25 cell types to
make the figure more readable.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="st">"Lung5_Rep1"</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="va">query_list</span><span class="op">[[</span><span class="va">tissueName</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="st">"tumor interior"</span></span>
<span><span class="va">qu_sub</span> <span class="op">&lt;-</span> <span class="va">query</span><span class="op">[</span>,<span class="va">query</span><span class="op">$</span><span class="va">niche</span><span class="op">==</span><span class="va">x</span><span class="op">]</span></span>
<span><span class="va">corMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDims</a></span><span class="op">(</span><span class="va">qu_sub</span><span class="op">)</span><span class="op">[[</span><span class="st">"PhiSpace"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">cVars</span> <span class="op">&lt;-</span> <span class="fu">colVars</span><span class="op">(</span><span class="va">corMat</span><span class="op">)</span></span>
<span><span class="va">selectedTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cVars</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="op">-</span><span class="va">cVars</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">25</span><span class="op">]</span></span>
<span><span class="va">corMat</span> <span class="op">&lt;-</span> <span class="va">corMat</span><span class="op">[</span><span class="va">selectedTypes</span>, <span class="va">selectedTypes</span><span class="op">]</span></span>
<span><span class="va">hm</span> <span class="op">&lt;-</span> <span class="fu">tempHeatmap</span><span class="op">(</span></span>
<span>  <span class="va">corMat</span>, binColour <span class="op">=</span> <span class="cn">F</span>, fsize <span class="op">=</span> <span class="fl">12</span>, useSeriate <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span>
<span><span class="va">hm</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>Compute all co-presence matrices.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corMatVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tissueNames</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">ii</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="va">tissueNames</span><span class="op">[</span><span class="va">ii</span><span class="op">]</span></span>
<span>    <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">query_list</span><span class="op">[[</span><span class="va">tissueName</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">tempNicheNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">niche</span><span class="op">)</span></span>
<span>    <span class="co"># List of correlation matrices (corMats)</span></span>
<span>    <span class="va">corMat_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>      <span class="va">tempNicheNames</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>        </span>
<span>        <span class="va">nicheName</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span>        <span class="va">corMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span><span class="op">[</span>,<span class="va">query</span><span class="op">$</span><span class="va">niche</span><span class="op">==</span><span class="va">nicheName</span><span class="op">]</span>, <span class="st">"PhiSpace"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">corMat</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">corMat_list</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tempNicheNames</span></span>
<span>    <span class="co"># Labels for entries in each corMat</span></span>
<span>    <span class="va">cTypeCombo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">corMat_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">corMat_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"&lt;-&gt;"</span>, <span class="va">y</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="co"># Vectorise corMats</span></span>
<span>    <span class="va">corMatVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>      <span class="va">corMat_list</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">lower.tri</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">`colnames&lt;-`</span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">tempNicheNames</span>, <span class="st">"_"</span>, <span class="va">tissueName</span><span class="op">)</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">`rownames&lt;-`</span><span class="op">(</span></span>
<span>        <span class="va">cTypeCombo</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">lower.tri</a></span><span class="op">(</span><span class="va">cTypeCombo</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">corMatVec</span> <span class="op">&lt;-</span> <span class="va">corMatVec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        niche <span class="op">=</span> <span class="va">tempNicheNames</span>,</span>
<span>        sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">tissueName</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">corMatVec</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">corMatVec</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">corMatVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">corMatVec</span><span class="op">)</span></span>
<span><span class="co"># Delete niches with fewer than 50 cells</span></span>
<span><span class="va">minNicheCells</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">nicheTabs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">query_list</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">tissueName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">query_list</span><span class="op">)</span><span class="op">[</span><span class="va">x</span><span class="op">]</span></span>
<span>    <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">query_list</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">niche</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="va">tissueName</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">nPerNiche</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">nicheTabs</span><span class="op">)</span> </span>
<span><span class="va">corMatVec</span> <span class="op">&lt;-</span> <span class="va">corMatVec</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">nPerNiche</span><span class="op">)</span><span class="op">[</span><span class="va">nPerNiche</span> <span class="op">&gt;=</span> <span class="va">minNicheCells</span><span class="op">]</span>, <span class="op">]</span></span></code></pre></div>
<p>PCA of all spatial-domain-specific co-presence matrices. The PC plot
using PC1 and PC2 is very interesting. First we can see that there is a
separation of tumour domains (tumour interior and tumour-stroma
boundary) from non-tumour domains. But this separation is not along a
single PC so we cannot simply attribute this separation to a PC and plot
its loadings as we did in the Visium case study. Another thing is that
tumour domains from Lung 5 (shortend as L5 on plot) are separated from
tumour domains from other lungs.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">012361</span><span class="op">)</span></span>
<span><span class="va">pca_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getPC.html">getPC</a></span><span class="op">(</span><span class="va">corMatVec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">niche</span>, <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span>, ncomp <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu">tempPCAplot</span><span class="op">(</span><span class="va">pca_res</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expand_limits.html" class="external-link">expand_limits</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">9</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<p>To investigate how tumour domains are different from non-tumour ones
in terms of cell type co-presence, we conduced a discriminant analysis
using <a href="https://www.jstor.org/stable/27639976" class="external-link">DWD</a>. DWD is an
improved version of support vector machine (SVM), solving SVM’s problems
when applied to high-dimensional data. As DWD is a linear method, has
very good interpretability. We can easily extract features that are most
useful for separating two classes (DWD is a binary classifier). Note
that we use the <code>kerndwd</code> package, which is a <a href="https://academic.oup.com/jrsssb/article/80/1/177/7048416" class="external-link">more
efficient implementation</a> of DWD.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">kerndwd</span><span class="op">)</span></span>
<span><span class="va">nicheBinary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">corMatVec</span><span class="op">$</span><span class="va">niche</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tumor interior"</span>, <span class="st">"tumor-stroma boundary"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nicheBinary</span><span class="op">[</span><span class="va">nicheBinary</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">nicheBinaryByName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Non-cancer niches"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nicheBinary</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nicheBinaryByName</span><span class="op">[</span><span class="va">nicheBinary</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Cancer niches"</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="va">corMatVec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">niche</span>, <span class="va">sample</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">as.matrix</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">012361</span><span class="op">)</span></span>
<span><span class="va">X_cent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X</span>, center <span class="op">=</span> <span class="cn">T</span>, scale <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">3</span>, <span class="op">-</span><span class="fl">3</span>, length.out<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">kern</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/dots.html" class="external-link">vanilladot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cv_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/cv.kerndwd.html" class="external-link">cv.kerndwd</a></span><span class="op">(</span><span class="va">X_cent</span>, <span class="va">nicheBinary</span>, <span class="va">kern</span>, qval<span class="op">=</span><span class="fl">1</span>, lambda<span class="op">=</span><span class="va">lambda</span>, eps<span class="op">=</span><span class="fl">1e-5</span>, maxit<span class="op">=</span><span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="va">da_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/kerndwd.html" class="external-link">kerndwd</a></span><span class="op">(</span><span class="va">X_cent</span>, <span class="va">nicheBinary</span>, <span class="va">kern</span>, qval<span class="op">=</span><span class="fl">1</span>, lambda<span class="op">=</span><span class="va">cv_res</span><span class="op">$</span><span class="va">lambda.min</span>, eps<span class="op">=</span><span class="fl">1e-5</span>, maxit<span class="op">=</span><span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="va">da_res</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span></span>
<span><span class="va">dwdLoad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/matmult-methods.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">X_cent</span>, <span class="va">A</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="st">"comp1"</span><span class="op">)</span> <span class="co"># worked out by looking at predict.dwd</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dwdLoad</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\([^\\)]*\\)"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">dwdLoad</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dwdScore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/predict.kerndwd.html" class="external-link">predict.kerndwd</a></span><span class="op">(</span><span class="va">da_res</span>, <span class="va">kern</span>, <span class="va">X_cent</span>, <span class="va">X_cent</span>, <span class="st">"link"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="st">"comp1"</span><span class="op">)</span></span>
<span><span class="va">dwd_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  scores <span class="op">=</span> <span class="va">dwdScore</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>, loadings <span class="op">=</span> <span class="va">dwdLoad</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Like PCA, DWD can also provide scores and loadings. To distinguish
tumour and non-tumour spatial domains, DWD projects the domain-specific
co-presense matrices to one direction that can best separate these two
types of domains, resulting in 1-dimensional representation of these
matrices, i.e. scores. Loadings represent how this direction is defined,
i.e. which cell type co-presence best distinguished tumour and
non-tumour spatial domains.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dwd_res</span><span class="op">$</span><span class="va">scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    niche <span class="op">=</span> <span class="va">nicheBinaryByName</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">comp1</span>, fill <span class="op">=</span> <span class="va">niche</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubr</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span><span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"DWD score"</span><span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loadBarplot.html">loadBarplot</a></span><span class="op">(</span><span class="va">dwd_res</span><span class="op">$</span><span class="va">loadings</span>, <span class="st">"comp1"</span>, xlab <span class="op">=</span> <span class="st">"DWD loading"</span>, nfeat <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    axis.title.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.ticks.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="CosMx_files/figure-html/unnamed-chunk-17-2.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/jiadongm" class="external-link">Jiadong Mao</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
