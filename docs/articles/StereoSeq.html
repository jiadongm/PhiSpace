<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stereo-seq: lineage commitment of AML cells • PhiSpace</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Stereo-seq: lineage commitment of AML cells">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">PhiSpace</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>

  </a>
</li>
<li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Stereo-seq: lineage commitment of AML cells</h1>
                        <h4 data-toc-skip class="author">Jiadong
Mao</h4>
            
            <h4 data-toc-skip class="date">2025-04-29</h4>
      

      <div class="hidden name"><code>StereoSeq.Rmd</code></div>

    </div>

    
    
<div class="section level3">
<h3 id="highlights">Highlights<a class="anchor" aria-label="anchor" href="#highlights"></a>
</h3>
<ul>
<li><p>Annotation using multiple references;</p></li>
<li><p>Annotation of spatial bins (without cell segmentation);</p></li>
<li><p>Identify cell states of a large number of cancer clones.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this case study, we will apply PhiSpace to identify clone-specific
cell states in an acute myeloid leukaemia (AML) mouse model. The results
show that genetically identical AML clones developed different cell
states, suggesting that they might commited to different lineages
(e.g. lymphocytes vs granulocytes).</p>
<ul>
<li>Query: Stereo-seq data from a mouse spleen containing AML cells (<a href="https://www.cell.com/cell-reports-methods/fulltext/S2667-2375(24)00094-8?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS2667237524000948%3Fshowall%3Dtrue" class="external-link">Holze
et al., 2024</a>).</li>
<li>Reference: 4 scRNA-seq datasets from healthy and cancerous mouse
spleen, bone marrow and neutrophils
<ul>
<li>Spleen: healthy mosue spleen (<a href="https://www.sciencedirect.com/science/article/abs/pii/S1673852723001091?via%3Dihub" class="external-link">Zhang
et al., 2023</a>);</li>
<li>BM: healthy mouse bone marrow atlas (<a href="https://gillisweb.cshl.edu/HSC_atlas/" class="external-link">Harris et al.,
2021</a>);</li>
<li>CITE: healthy mouse spleen CITE-seq (RNA+surface protein, we only
used the RNA part) (<a href="https://www.nature.com/articles/s41592-020-01050-x" class="external-link">Gayoso et al.,
2021</a>);</li>
<li>Neutrophil: single-neutrophil RNA-seq from various types of mosue
tissues (healthy and cancerous cell states) (<a href="https://www.science.org/doi/10.1126/science.adf6493" class="external-link">Ng et al.,
2024</a>).</li>
</ul>
</li>
</ul>
<p>In addition, we also make use of a ‘bridge’ dataset as an
intermediate between the four reference datasets and the Stereo-seq
query:</p>
<ul>
<li>Bridge: scRNA-seq from same mouse spleen as the Stereo-seq data (<a href="https://www.nature.com/articles/s41586-021-04206-7" class="external-link">Fennell et
al., 2021</a>).</li>
</ul>
<p>For this case study, utility functions and processed data can all be
found in <a href="https://www.dropbox.com/scl/fo/4w5vweo2ky2vuf7g591fe/AMDVr2OAUL5W1wO7ATzM754?rlkey=aggfds07sjymsd2aomyepbylv&amp;st=a0e2g675&amp;dl=0" class="external-link">this
folder</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Name of the game</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jiadongm.github.io/PhiSpace/">PhiSpace</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Tidyverse packages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/" class="external-link">ggpubr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Other utils</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/qsbase/qs" class="external-link">qs</a></span><span class="op">)</span><span class="op">)</span> <span class="co"># Fast read and write of large R objects</span></span>
<span></span>
<span><span class="va">dat_dir</span> <span class="op">&lt;-</span> <span class="st">"~/Dropbox/Research_projects/PhiSpace/VignetteData/StereoSeq/"</span> <span class="co"># replace this by your own directory</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"StereoSeq_utils.R"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Following <a href="https://www.cell.com/cell-reports-methods/fulltext/S2667-2375(24)00094-8?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS2667237524000948%3Fshowall%3Dtrue" class="external-link">Holze
et al.</a> (2024), we binned the tissue domain into so-called ‘bin50’
size, resulting in transcript bins with side lengths ~25μm. These bins
are larger than typical single cells and hence each bin may contain more
than one cell. These bins will be our cell-like objects.</p>
<p><strong>Note on cell segmentation.</strong> For subcellular spatial
RNA-seq, reliable cell segmentation is not always possible. This is
because reliable cell segmentation relies on cell staining such as DAPI
and advanced imaging machine learning algorithms (can be
time-consuming). And the quality of cell segmentation varies from tissue
to tissue, with some tissues such as spleen intrisically difficult to
segment due to its complex morphological structures and croweded,
overlapping immune cells. If additional cell staining is not included in
experimental design (i.e. you unfortunately did pay for it), then cell
segmentation cannot be very accurate. In this Stereo-seq case, cell
segmentation was not possible due to a phenomenon called ‘swapping’ or
‘bleeding’, i.e. transcripts bleeding among neighbouring measurement
units causing contamination. This phenomenon is actually <a href="https://www.nature.com/articles/s41467-022-30587-y" class="external-link">fairly
common</a> (no data is perfect!).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">queryPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/mouse4_bin50_bc_sce.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="cn">F</span><span class="op">)</span><span class="op">{</span> <span class="co"># The data has already been normalised, but if you want to try again, change F to T</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">queryPath</span><span class="op">)</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RankTransf.html">RankTransf</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"counts"</span><span class="op">)</span> <span class="co"># Rank transform</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logTransf.html">logTransf</a></span><span class="op">(</span><span class="va">query</span>, targetAssay <span class="op">=</span> <span class="st">"log1p"</span>, use_log1p <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">query</span>, <span class="va">queryPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">query</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">queryPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Visualise total RNA counts. delete bins with too few transcripts.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, groupBy <span class="op">=</span> <span class="st">"total_counts"</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell2keep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">[</span><span class="va">query</span><span class="op">$</span><span class="va">total_counts</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">total_counts</span>, <span class="fl">0.01</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="va">query</span><span class="op">[</span>,<span class="va">cell2keep</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="barcode-seq-analysis-defining-meta-clones">Barcode-seq analysis: defining meta-clones<a class="anchor" aria-label="anchor" href="#barcode-seq-analysis-defining-meta-clones"></a>
</h2>
<div class="section level3">
<h3 id="decipher-evolution-of-cancer">Decipher evolution of cancer<a class="anchor" aria-label="anchor" href="#decipher-evolution-of-cancer"></a>
</h3>
<p>This Stereo-seq data we analyse here is special since it’s one of the
first spatial RNA-seq data with cancer clone lineage tracing information
(<a href="https://www.cell.com/cell-reports-methods/fulltext/S2667-2375(24)00094-8?_returnURL=https%3A%2F%2Flinkinghub.elsevier.com%2Fretrieve%2Fpii%2FS2667237524000948%3Fshowall%3Dtrue" class="external-link">Holze
et al., 2024</a>).</p>
<p>A cancer clone refers to descendants from the same ancestor cell
which share identical genome (i.e. same DNA) <a href="https://www.science.org/doi/10.1126/science.959840" class="external-link">(Nowell,
1976)</a>. Thanks to increasingly cheaper DNA sequencing, we now know
that a tumour is usually a patchwork of cancer clones, some more
populous and hence more ‘successful’ than others. It is now a consensus
that cancer is an evolutionary process, where many different clones
compete with each other and the fittest of them survive (<a href="https://www.embopress.org/doi/full/10.15252/embj.2021108389" class="external-link">Vendramin
et al., 2021</a>). Intriguingly enough, this evolutionary process cannot
be fully explained by genetics. For example, we now know that some
cancer clones are more successful in terms of therapeutic resistance not
because they have a more advantageous gene mutations (e.g. a mutation
making it easier for them to proliferate), but because of some
non-genetic mechanisms <a href="https://www.nature.com/articles/s41568-020-00302-4" class="external-link">(Marine et
al., 2020)</a>.</p>
<p>The need to understand non-genetic mechanisms underpinning some key
cancer evolutionary events, such as therapeutic resistance, motivated
the development of SPLINTR (single-cell profiling and lineage tracing),
a barcoding technology allowing us to sequencing cancer cells while
retaining their clonal identities <a href="https://www.nature.com/articles/s41586-021-04206-7" class="external-link">(Fennell et
al., 2022)</a>. That is, via SPLINTR we can know which cancer cells
belong to the same clone and what are their transcriptional profiles. It
is a powerful tool for exploring non-genetic mechanisms since we can see
how genetically identical clones develop different transcriptional
programs, and hence exhibiting different cell states. Ultimately we
might decipher how cancer cells (they are really cunning!) utilise
diverse transcriptional programs to evade host immune response and
acquire resistance to cancer therapies.</p>
<p><strong>Bibliographic note:</strong> the evolutionary theory of
cancer hasn’t really been a research focus until recent years after we
have access to powerful and more affordable DNA sequencing. But the
theoretical framework was discussed as early as 1976 by Peter Nowell in
his seminal paper <a href="https://www.science.org/doi/10.1126/science.959840" class="external-link"><em>The Clonal
Evolution of Tumor Cell Populations</em></a>. Though people knew very
little about cancer genomics back then, the framework of Nowell was
suprisingly ahead of his time.</p>
</div>
<div class="section level3">
<h3 id="visualise-aml-clones">Visualise AML clones<a class="anchor" aria-label="anchor" href="#visualise-aml-clones"></a>
</h3>
<p>Before plunging into the gene expression space, let’s first look at
what SPLINTR tells us about how the AML clones are distributed in the
mouse spleen. The input we use here is a so-called barcode-seq file,
which is a table telling us which clones are detected and what are their
spatial coordinates. Since cells in the same clone have the same SPLINTR
barcode, detecting whereabouts of clones is equivalent to detecting
whereabouts of barcodes.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load barcode-seq</span></span>
<span><span class="va">bcRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/mouse4_bin50_bc_counts.tsv"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"\t"</span>, header <span class="op">=</span> <span class="cn">T</span>, row.names <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Match spatial coordinates with sce object</span></span>
<span><span class="va">bcRaw</span><span class="op">$</span><span class="va">bin_y</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">bin_y</span></span>
<span><span class="va">bcRaw</span><span class="op">$</span><span class="va">y_center</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">y_center</span></span>
<span><span class="va">isin_data</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">isin_adata</span> <span class="op">==</span> <span class="st">"True"</span><span class="op">)</span></span>
<span><span class="co"># Simplify barcode names</span></span>
<span><span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"GFP_"</span>, <span class="st">""</span>, <span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span><span class="op">)</span></span>
<span><span class="co"># Bins that do not contain barcodes</span></span>
<span><span class="va">noBarIdx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">cell_id</span>, <span class="va">bcRaw</span><span class="op">$</span><span class="va">cell_id</span><span class="op">[</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">isin_adata</span> <span class="op">==</span> <span class="st">"True"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># Show part of barcode-seq</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">bcRaw</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          barcode count_binned bin_x bin_y  cell_id x_center y_center isin_adata</span></span>
<span><span class="co">## 0  Barcode_32756           13    90  -123   90_123    13645   -17865      False</span></span>
<span><span class="co">## 1     Barcode_25           11  -128  -194 -128_194     2745   -21415      False</span></span>
<span><span class="co">## 2 Barcode_131914           10  -104   -83  -104_83     3945   -15865      False</span></span>
<span><span class="co">## 3 Barcode_131914            9  -124  -207 -124_207     2945   -22065      False</span></span>
<span><span class="co">## 4 Barcode_131914            9   208   -22   208_22    19545   -12815      False</span></span>
<span><span class="co">## 5   Barcode_2613            8   -35  -103  -35_103     7395   -16865      False</span></span></code></pre>
<p>There were 370 clones/barcodes detected but most of them were very
scarce.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcTab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bcTab</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 370</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcTab</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     Barcode_25   Barcode_2613 Barcode_131914  Barcode_25027   Barcode_6595 </span></span>
<span><span class="co">##           5428           3073           2922           1376           1183 </span></span>
<span><span class="co">##  Barcode_19949   Barcode_5687  Barcode_25727  Barcode_42724  Barcode_32756 </span></span>
<span><span class="co">##            814            723            707            490            470 </span></span>
<span><span class="co">##  Barcode_12424   Barcode_1190      Barcode_8   Barcode_1794 Barcode_120950 </span></span>
<span><span class="co">##            435            328            320            280            238 </span></span>
<span><span class="co">##  Barcode_87074  Barcode_10626   Barcode_3036  Barcode_70639   Barcode_1209 </span></span>
<span><span class="co">##            189            174            122            115            114 </span></span>
<span><span class="co">##  Barcode_49666 Barcode_108275 Barcode_150642 Barcode_146599  Barcode_69630 </span></span>
<span><span class="co">##            114            103            103             99             90 </span></span>
<span><span class="co">##  Barcode_50878     Barcode_43  Barcode_28543   Barcode_6537   Barcode_5925 </span></span>
<span><span class="co">##             85             82             73             70             67</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcTab</span><span class="op">[</span><span class="fl">341</span><span class="op">:</span><span class="fl">370</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Barcode_62985 Barcode_67039 Barcode_68225  Barcode_6850  Barcode_6957 </span></span>
<span><span class="co">##             1             1             1             1             1 </span></span>
<span><span class="co">## Barcode_70428 Barcode_70487  Barcode_7114 Barcode_71766  Barcode_7262 </span></span>
<span><span class="co">##             1             1             1             1             1 </span></span>
<span><span class="co">## Barcode_73834 Barcode_74003 Barcode_76770 Barcode_79993 Barcode_80014 </span></span>
<span><span class="co">##             1             1             1             1             1 </span></span>
<span><span class="co">##  Barcode_8051 Barcode_82825 Barcode_82916  Barcode_8369 Barcode_84496 </span></span>
<span><span class="co">##             1             1             1             1             1 </span></span>
<span><span class="co">## Barcode_87623 Barcode_88641 Barcode_88652 Barcode_88815  Barcode_8942 </span></span>
<span><span class="co">##             1             1             1             1             1 </span></span>
<span><span class="co">## Barcode_91999   Barcode_922 Barcode_93569 Barcode_95213  Barcode_9983 </span></span>
<span><span class="co">##             1             1             1             1             1</span></span></code></pre>
<p>We visualise the spatial distributions of some of the dominating
clones. This helps us see if a clone tends to concentrate within a
spatial region, and if different clones tend to concentrate in different
regions. In solid tumours (e.g. lung tumours) clones are normally
clustered together spatially but we are dealing with liquid tumour here
(leukaemia) so the spatial clonal patterns are not well understood.</p>
<p>We first define some useful quantities for plotting.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Which coordinates to use</span></span>
<span><span class="va">xCoordName</span> <span class="op">&lt;-</span> <span class="st">"x_center"</span></span>
<span><span class="va">yCoordName</span> <span class="op">&lt;-</span> <span class="st">"y_center"</span></span>
<span><span class="co"># X and Y limits</span></span>
<span><span class="va">xylimits</span> <span class="op">&lt;-</span> <span class="va">bcRaw</span><span class="op">[</span><span class="va">isin_data</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xCoordName</span>, <span class="va">yCoordName</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## Convex hull defining spleen region </span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ch</span> <span class="op">&lt;-</span> <span class="va">ch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/grDevices/chull.html" class="external-link">chull</a></span><span class="op">(</span><span class="va">ch</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">sortedBC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<p>We first plot the density of all clones using two-dimensional kernel
density estimation (KDE). This tells us if AML cells tend to occupy
certain spatial niches or that they are spreading evenly. (Need to
install <code>ks</code> package for kernel smoothing.)</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xx_eval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">[</span><span class="va">query</span><span class="op">$</span><span class="va">barcode</span> <span class="op">!=</span> <span class="st">"nan"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="va">xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">colData</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span><span class="op">[</span><span class="va">query</span><span class="op">$</span><span class="va">barcode</span> <span class="op">!=</span> <span class="st">"nan"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">kde_res</span> <span class="op">&lt;-</span> <span class="fu">tempDenPlot</span><span class="op">(</span><span class="va">xx</span>, <span class="va">xx_eval</span>, <span class="va">xylimits</span>, <span class="va">ch</span>, <span class="cn">F</span>, psize <span class="op">=</span> <span class="fl">1</span>, <span class="st">""</span>, spleenOnly <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">estValues</span> <span class="op">&lt;-</span> <span class="va">kde_res</span><span class="op">$</span><span class="va">kde_res</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="va">estRange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">estValues</span><span class="op">)</span></span>
<span><span class="va">kde_res</span><span class="op">$</span><span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">PhiSpace</span><span class="fu">:::</span><span class="va">MATLAB_cols</span>, limits <span class="op">=</span> <span class="va">estRange</span><span class="op">)</span> </span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Overall AML cells seemed to clustered in space. We then do KDE for
the top 16 clones.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sortedBC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span>decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">xx_eval</span> <span class="op">&lt;-</span> <span class="va">bcRaw</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xCoordName</span>, <span class="va">yCoordName</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">kdePath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/cloneKDEres.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">kdePath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span><span class="op">:</span><span class="fl">16</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="co"># Which clone</span></span>
<span>      <span class="va">bcName</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sortedBC</span><span class="op">)</span><span class="op">[</span><span class="va">x</span><span class="op">]</span></span>
<span>      <span class="co"># Data for density est</span></span>
<span>      <span class="va">xx</span> <span class="op">&lt;-</span> <span class="va">bcRaw</span><span class="op">[</span><span class="va">bcRaw</span><span class="op">$</span><span class="va">barcode</span> <span class="op">==</span> <span class="va">bcName</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">xCoordName</span>, <span class="va">yCoordName</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">kde_res</span> <span class="op">&lt;-</span> <span class="fu">tempDenPlot</span><span class="op">(</span><span class="va">xx</span>, <span class="va">xx_eval</span>, <span class="va">xylimits</span>, <span class="va">ch</span>, <span class="cn">F</span>, psize <span class="op">=</span> <span class="fl">0.3</span>, <span class="va">bcName</span>, spleenOnly <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">kde_res</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">out</span>, <span class="va">kdePath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">kdePath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">estValues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">out</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">kde_res</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="va">unlist</span></span>
<span><span class="va">estRange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">estValues</span><span class="op">)</span></span>
<span><span class="va">outPlots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">out</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">p</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span></span>
<span>      <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_colour_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu">PhiSpace</span><span class="fu">:::</span><span class="va">MATLAB_cols</span>, limits <span class="op">=</span> <span class="va">estRange</span><span class="op">)</span> </span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">outPlots</span>, nrow <span class="op">=</span> <span class="fl">4</span>, ncol <span class="op">=</span> <span class="fl">4</span>, legend <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>These individual KDE plots revealed some spatial patterns of
individual clones. The most populous clone with Barcode_25, for example,
tended to occupy the top left corner. Some clones, such as
Barcode_19949, tended to spread out more evenly.</p>
</div>
<div class="section level3">
<h3 id="define-meta-clones">Define meta-clones<a class="anchor" aria-label="anchor" href="#define-meta-clones"></a>
</h3>
<p>How do we summarise the spatial patterns of all these clones? Instead
of viewing them one by one, we aggregate the high abundance clones into
meta-clones.</p>
<p>We first filter out low abundance barcodes. The idea is that, most
barcodes have very low abundance (e.g. detected in only one bin) and
it’s not very interesting analysing them here since they do not tell us
much about how AML clones tend to be distributed in space. However this
doesn’t mean that the low-abundance clones are not biologically
important. Some rare clones may not seem very successful when cancer is
expanding but they might be able to develop resistance to, say,
chemotherapy, so they might take over after chemo. All we are saying
here is that the low-abundance clones can be left out in the currently
analysis of spatial patterns, which really rely on higher-abundance
clones to provide more statistical power.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sortedBC_filt</span> <span class="op">&lt;-</span> <span class="va">sortedBC</span><span class="op">[</span><span class="va">sortedBC</span> <span class="op">&gt;=</span> <span class="fl">50</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sortedBC_filt</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 35</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcFilt</span> <span class="op">&lt;-</span> <span class="va">bcRaw</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">barcode</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sortedBC_filt</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>barcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">barcode</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We only kept 35 clones with more than 50 cells each. Next we cluster
the Stereo-seq bins according to their composition of clones. That is,
two bins will belong to the same cluster, which we call a meta-clone, if
they have similar composition of individual clones. However, due to the
relatively small bin size (~25μm), each bin contained only a few
barcode. Hence we do some spatial smoothing as follows.</p>
<p>For a given Stereo-seq bin, we count the barcodes present in the
surrounding bins whose distances to that given bin is no larger than
<code>xyRange</code>. We selected <code>xyRange &lt;- 50</code> and
noted that the specific value of <code>xyRange</code> doesn’t tend to
change the clustering results much.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xyRange</span> <span class="op">&lt;-</span> <span class="fl">500</span></span>
<span><span class="va">binIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span></span>
<span><span class="va">barAssay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">binIDs</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">binID</span> <span class="op">&lt;-</span> <span class="va">binIDs</span><span class="op">[</span><span class="va">x</span><span class="op">]</span></span>
<span>    <span class="va">coords</span> <span class="op">&lt;-</span> <span class="va">bcFilt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cell_id</span> <span class="op">==</span> <span class="va">binID</span><span class="op">)</span></span>
<span>    <span class="va">coords</span> <span class="op">&lt;-</span> <span class="va">coords</span><span class="op">[</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x_center"</span>, <span class="st">"y_center"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">xcond</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">$</span><span class="va">x_center</span> <span class="op">-</span> <span class="va">coords</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">xyRange</span><span class="op">)</span></span>
<span>    <span class="va">ycond</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">$</span><span class="va">y_center</span> <span class="op">-</span> <span class="va">coords</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">xyRange</span><span class="op">)</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="va">xcond</span> <span class="op">&amp;</span> <span class="va">ycond</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">[</span><span class="va">idx</span>,<span class="st">"barcode"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="va">binIDs</span><span class="op">)</span></span></code></pre></div>
<p>Next we cluster the bins with smoothed out clonal composition using
k-means. We try different choices of number of clusters.</p>
<p><strong>Note on k-means</strong>: the default setting of
<code>kmeans</code> in R is actually inappropriate for many
applications. First, <code>kmeans</code> uses random initialisation of
cluster centroid, so each run of it may give you slightly different
clustering results. It’s almost always a good idea to set
<code>nstart</code> to be some large number such as 50, so that the
function will run k-means for multiple times and selected the best one
(with tighter clusters) as final output. Second thing is that the
default maximal number of iterations controlled by <code>iter.max</code>
is set to be too small (only 10) by default. The clustering often cannot
converge with such as small number of iterations. So it needs to be set
larger by hand. My personal guess is that R inherits its early
implementation of k-means, when the number of iterations had to be set
small due to limited computing resource.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cell_id"</span>, <span class="va">xCoordName</span>, <span class="va">yCoordName</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">clustPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>,<span class="st">"output/barcode-seq_clustering.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">clustPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">523423</span><span class="op">)</span></span>
<span>  <span class="va">outClusts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>    <span class="fl">2</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">kclust</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">barAssay</span>, centers <span class="op">=</span> <span class="va">kclust</span>, iter.max <span class="op">=</span> <span class="fl">100</span>, nstart <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">clust_res</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">outClusts</span>, <span class="va">clustPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">outClusts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">clustPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next we visualise the clusters, or meta-clones. The idea is to select
a number of meta-clones based on this visualisation. Now a trick we use
in PhiSpace is to <strong>align</strong> the clusters across different
clustering results, so that two clusters similar to each other will
receive the same label. This cluster alignment is done by
<code><a href="../reference/align_clusters.html">PhiSpace::align_clusters</a></code>. This is actually a very useful
functionality as clusters in clustering algorithms are arbitrarily
named. So even the same cluster in two cluster results might be labelled
differently (e.g. labelled 1 in one run of k-means, labelled 2 in
another). This will make their visualisation harder to compare since
even the same cluster will receive two colours across two results.</p>
<p><strong>Technical note</strong>: we align the clusters using the
Hungarian algorithm implemented by <code><a href="https://rdrr.io/pkg/clue/man/solve_LSAP.html" class="external-link">clue::solve_LSAP</a></code>.
Similar clusters across different cluster results will be labelled using
the same number.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clust_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">outClusts</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">cluster</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Align clusters across different results</span></span>
<span><span class="va">outPlots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">clust_list</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">x</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">clust_list</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">clust</span> <span class="op">&lt;-</span> <span class="va">clust_list</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">clust_list</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">clust_old</span> <span class="op">&lt;-</span>  <span class="va">clust_list</span><span class="op">[[</span><span class="va">x</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/align_clusters.html">align_clusters</a></span><span class="op">(</span><span class="va">clust</span>, <span class="va">clust_old</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">clust_list</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">clust</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">plot_dat</span> <span class="op">&lt;-</span> <span class="va">plot_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">clust_list</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">outPlots</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">tempClustPlot</span><span class="op">(</span><span class="va">plot_dat</span>, <span class="cn">T</span>, pSize <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html" class="external-link">ggarrange</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">outPlots</span>, nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">3</span>, legend <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>Some meta-clones, such as the pink one, appeared very early, even
when there were only two clusters. This means that these clones are more
significant in some sense. To interpret the clusters, we look at clone
composition of each cluster.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">binIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">$</span><span class="va">cell_id</span><span class="op">)</span></span>
<span><span class="va">barAssayRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">binIDs</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">binID</span> <span class="op">&lt;-</span> <span class="va">binIDs</span><span class="op">[</span><span class="va">x</span><span class="op">]</span></span>
<span>    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">bcFilt</span><span class="op">$</span><span class="va">cell_id</span> <span class="op">==</span> <span class="va">binID</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">bcFilt</span><span class="op">[</span><span class="va">idx</span>,<span class="st">"barcode"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`rownames&lt;-`</span><span class="op">(</span><span class="va">binIDs</span><span class="op">)</span></span>
<span><span class="va">clustIdx</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="va">clust_list</span><span class="op">[[</span><span class="va">clustIdx</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">barSelected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sortedBC</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">plot_dat_wide</span> <span class="op">&lt;-</span> <span class="va">barAssayRaw</span><span class="op">[</span>,<span class="va">barSelected</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">clust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"Barcode"</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">plot_prop</span> <span class="op">&lt;-</span> <span class="va">plot_dat_wide</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">clust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">plot_prop</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">plot_prop</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums-methods.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">plot_prop</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clust <span class="op">=</span> <span class="va">plot_dat_wide</span><span class="op">$</span><span class="va">clust</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="op">!</span><span class="va">clust</span>, values_to <span class="op">=</span> <span class="st">"count"</span>, names_to <span class="op">=</span> <span class="st">"barcode"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>barcode <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">barcode</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">barSelected</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">plot_prop</span> <span class="op">&lt;-</span> <span class="va">plot_prop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">clust</span> <span class="op">!=</span> <span class="st">"9"</span><span class="op">)</span></span>
<span><span class="va">plot_prop</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">count</span>, <span class="va">barcode</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clust</span><span class="op">)</span>, stat <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">clust_cols</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">clust</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">"none"</span>, axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span>, face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tempClustPlot</span><span class="op">(</span><span class="va">plot_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clusters <span class="op">=</span> <span class="va">clust_list</span><span class="op">[[</span><span class="va">clustIdx</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="cn">T</span>, pSize <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-13-2.png" width="700"></p>
<p>We picked number of meta-clones equal to 8 since most meta-clones
contained 1 dominant barcode, except for clone 5, which contained a bit
of everything and did really show an interesting spatial pattern. Note
that meta-clone 9 was excluded since most of its cells were located
outside the spleen region, depicted by the black solid line. This is a
technical artefact we discussed above.</p>
</div>
</div>
<div class="section level2">
<h2 id="phispace-analyses">PhiSpace analyses<a class="anchor" aria-label="anchor" href="#phispace-analyses"></a>
</h2>
<p>After knowing how clones tended to be located in the spleen sample,
we now look at their cell states. As mentioned above, the experiment was
designed so that all clones have the same DNA, so they are ideal for
identifying non-genetic differences between AML clones.</p>
<p>Since the same mouse spleen was subjected to both Stereo-seq and
scRNA-seq, we use the matched scRNA-seq as a ‘bridge’ to enhance the
annotation of spatial bins. The idea is that we first use the four
scRNA-seq references to annotate the bridge scRNA-seq, and then use the
annotated bridge scRNA-seq to annotate Stereo-seq. The reasoning for
this bridging approach is that, technically, the references and the
bridge datasets are more similar and, biologically, the bridge and the
query Stereo-seq datasets are more similar. It turns out that the
PhiSpace annotation makes more sense using the bridging approach
compared to directly annotating the query using the references.</p>
<p>Annotation of the bridge dataset is tedious and requires larger
memory to run (see our source code on GitHub for details). So here we
only show how to use the annotated bridge scRNA-seq to annotate the
query Stereo-seq from the same mouse spleen.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PhiResPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/PhiRes.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">querySC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"data/mouse4_scRNAseq_sce.qs"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pathPhiSc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/Mouse4_scRNA-seq_PhiSc_list.rds"</span><span class="op">)</span></span>
<span>  <span class="va">impScPath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/ImpScores_for_Mouse4_scRNA-seq.rds"</span><span class="op">)</span></span>
<span>  <span class="va">scPhiSc_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">pathPhiSc</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">querySC</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"cbind"</span>, <span class="va">scPhiSc_list</span><span class="op">)</span></span>
<span>  <span class="va">newNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"RBC"</span>, <span class="st">"CD8 T"</span>, <span class="st">"Plasma"</span>, <span class="st">"Mature B"</span>, <span class="st">"cDC"</span>,</span>
<span>    <span class="st">"NK"</span>, <span class="st">"Neutro"</span>, <span class="st">"CD4 T"</span>, <span class="st">"Cr2 B"</span>, <span class="st">"HSPC"</span>,</span>
<span>    <span class="st">"Trans B"</span>, <span class="st">"Mono"</span>, <span class="st">"T"</span>, <span class="st">"Pre-B cycl"</span>, <span class="st">"Endo"</span>,</span>
<span>    <span class="st">"Cd7+ NK"</span>, <span class="st">"Macro"</span>, <span class="st">"pDC"</span>, <span class="st">"Baso"</span>, <span class="st">"Pre-B"</span>, </span>
<span>    <span class="st">"Mono"</span>, <span class="st">"Naive B"</span>, <span class="st">"Granulo"</span>, <span class="st">"Macro"</span>, <span class="st">"Imm B"</span>,</span>
<span>    <span class="st">"HPC"</span>, <span class="st">"Late pro-B"</span>, <span class="st">"Imm NK"</span>, <span class="st">"ProEryThBla"</span>, <span class="st">"T"</span>,</span>
<span>    <span class="st">"ErythBla"</span>, <span class="st">"T3"</span>, <span class="st">"MAT 3"</span>, <span class="st">"MAT 2"</span>, <span class="st">"IMM 1"</span>,</span>
<span>    <span class="st">"MAT 4"</span>, <span class="st">"MAT 1"</span>, <span class="st">"IMM 2"</span>, <span class="st">"T1"</span>, <span class="st">"T2"</span>,</span>
<span>    <span class="st">"PreNeu"</span>, <span class="st">"MAT 5"</span>, <span class="st">"MZ B"</span>, <span class="st">"Trans B"</span>, <span class="st">"Mat B"</span>,</span>
<span>    <span class="st">"CD122+ B"</span>, <span class="st">"Ifit3+CD4 T"</span>, <span class="st">"CD4 T"</span>, <span class="st">"pDC"</span>, <span class="st">"CD8 T"</span>,</span>
<span>    <span class="st">"B1 B"</span>, <span class="st">"NKT"</span>, <span class="st">"Ifit3+ B"</span>, <span class="st">"NK"</span>, <span class="st">"GD T"</span>,</span>
<span>    <span class="st">"ICOS+ Tregs"</span>, <span class="st">"Tregs"</span>, <span class="st">"Ly6+ mono"</span>, <span class="st">"Neutro"</span>, <span class="st">"Cycl B/T"</span>,</span>
<span>    <span class="st">"cDC2"</span>, <span class="st">"Ly6- mono"</span>, <span class="st">"RedPulp macro"</span>, <span class="st">"RBC"</span>, <span class="st">"Mig DC"</span>,</span>
<span>    <span class="st">"Ifit3+CD8 T"</span>, <span class="st">"cDC1"</span>, <span class="st">"Act CD4 T"</span>, <span class="st">"Plasma"</span>, <span class="st">"MZ/Marco+ macro"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">newNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="va">newNames</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(Spleen)"</span>, <span class="st">"(BM)"</span>, <span class="st">"(Neutro)"</span>, <span class="st">"(CITE)"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">scPhiSc_list</span>, <span class="va">ncol</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">querySC</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">newNames</span></span>
<span>  <span class="va">querySC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/logTransf.html">logTransf</a></span><span class="op">(</span><span class="va">querySC</span>, targetAssay <span class="op">=</span> <span class="st">"log1p"</span>, use_log1p <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="va">PhiRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhiSpaceR_1ref.html">PhiSpaceR_1ref</a></span><span class="op">(</span></span>
<span>    <span class="va">querySC</span>, <span class="va">query</span>, response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">querySC</span>, <span class="st">"PhiSpace"</span><span class="op">)</span>, </span>
<span>    PhiSpaceAssay <span class="op">=</span> <span class="st">"log1p"</span>, nfeat <span class="op">=</span> <span class="fl">500</span>, regMethod <span class="op">=</span> <span class="st">"PLS"</span>, scale <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">PhiRes</span>, <span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">PhiRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">PhiResPath</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normPhiScores.html">normPhiScores</a></span><span class="op">(</span><span class="va">PhiRes</span><span class="op">$</span><span class="va">PhiSpaceScore</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">query</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<p>Next we visualise some cell types. First we observed a strong
neutrophil identity, represented by Neutro(Spleen), Granulo(BM) and
T2(Neutro) cell types in different references (neutrophil in spleen,
granulocytes (including neutrophil) in bone marrow and a
cancer-associated neutrophil labelled T2). And the strong neutrophil
identity coincides with the biggest clone (see above). What is also
interesting is the distribution of erythrocytes. Several references
confirmed that there is a strong erythrocyte identity towards the right
boundary of spleen (e.g. erythroblast visualised below). Moreover, we
observed that the macrophage identity delineates ring-like structures,
which potentially correspond to the right-like marginal zones in spleen.
Naive B cell, on the other hand, delineates what are potentially the
white pulps.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"Neutro(Spleen)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"Granulo(BM)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-2.png" width="700"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"T2(Neutro)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-3.png" width="700"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"ErythBla(BM)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-4.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"Macro(Spleen)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-5.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, reducedDim <span class="op">=</span> <span class="st">"Naive B(BM)"</span>, censor <span class="op">=</span> <span class="cn">T</span>, fsize <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-15-6.png" width="700"></p>
<p>Next we cluster the PhiSpace cell type scores to identify spatial
niches. Note how niche 4 (red) seems to represent the marginal zone and
niche 7 (blue) seems to represent the white pulps. Niche 8 (green)
represents the location of the largest AML clone (see above).</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tempClustCols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"1"</span> <span class="op">=</span> <span class="st">"#FF7F00"</span>, <span class="st">"2"</span> <span class="op">=</span> <span class="st">"#377EB8"</span>, <span class="st">"3"</span> <span class="op">=</span> <span class="st">"#F781BF"</span>, <span class="st">"4"</span> <span class="op">=</span> <span class="st">"#984EA3"</span>, </span>
<span>  <span class="st">"5"</span> <span class="op">=</span> <span class="st">"#A65628"</span>, <span class="st">"6"</span> <span class="op">=</span> <span class="st">"#4DAF4A"</span>, <span class="st">"7"</span> <span class="op">=</span> <span class="st">"#FFFF33"</span>, <span class="st">"8"</span> <span class="op">=</span> <span class="st">"#E41A1C"</span>  </span>
<span><span class="op">)</span></span>
<span><span class="va">pathPhiClustRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/PhiClustRes.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">pathPhiClustRes</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">PhiPCRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getPC.html">getPC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span>, ncomp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">PhiPCRes</span><span class="op">$</span><span class="va">accuProps</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">PhiPCRes</span><span class="op">$</span><span class="va">accuProps</span><span class="op">)</span></span>
<span>  <span class="va">mat2clust</span> <span class="op">&lt;-</span> <span class="va">PhiPCRes</span><span class="op">$</span><span class="va">scores</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">tempClustCols</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">94863</span><span class="op">)</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">mat2clust</span>, centers <span class="op">=</span> <span class="fl">8</span>, iter.max <span class="op">=</span> <span class="fl">200L</span>, nstart <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">clust_res</span>, <span class="va">pathPhiClustRes</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">pathPhiClustRes</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">query</span><span class="op">$</span><span class="va">PhiClust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">clust_res</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, groupBy <span class="op">=</span> <span class="st">"PhiClust"</span>, ptSize <span class="op">=</span> <span class="fl">1</span>, legend.symb.size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">tempClustCols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>, legend.key.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>In contrast, we can cluster the Stereo-seq bins according to their
gene expression to identify the same number of spatial niches as above.
The features highlighted by PhiSpace niches, i.e. marginal zone, white
pulp and largest clone, were lost.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathGexClustRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/GexClustRes.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">pathGexClustRes</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mat2clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getPC.html">getPC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">assay</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"log1p"</span><span class="op">)</span><span class="op">)</span>, ncomp <span class="op">=</span> <span class="fl">30</span><span class="op">)</span><span class="op">$</span><span class="va">scores</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">94858</span><span class="op">)</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">mat2clust</span>, centers <span class="op">=</span> <span class="fl">8</span>, iter.max <span class="op">=</span> <span class="fl">200L</span>, nstart <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">clust_res</span>, <span class="va">pathGexClustRes</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">clust_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">pathGexClustRes</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">query</span><span class="op">$</span><span class="va">GenClust</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/align_clusters.html">align_clusters</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">clust_res</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span>, <span class="va">query</span><span class="op">$</span><span class="va">PhiClust</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/VizSpatial.html">VizSpatial</a></span><span class="op">(</span><span class="va">query</span>, groupBy <span class="op">=</span> <span class="st">"GenClust"</span>, ptSize <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">tempClustCols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span>,</span>
<span>    legend.position <span class="op">=</span> <span class="st">"right"</span>, legend.key.spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>We use DWD (see CosMx case study) to compare barcoded and
non-barcoded bins. Here barcoded bins refer to Stereo-seq bins where at
least one barcode was detected.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">kerndwd</span><span class="op">)</span></span>
<span><span class="va">barcodeVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">query</span><span class="op">$</span><span class="va">barcode</span><span class="op">)</span></span>
<span><span class="va">barcodeVec</span><span class="op">[</span><span class="va">barcodeVec</span> <span class="op">!=</span> <span class="st">"nan"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">barcodeVec</span><span class="op">[</span><span class="va">barcodeVec</span> <span class="op">==</span> <span class="st">"nan"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="va">barcodeVec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">barcodeVec</span><span class="op">)</span></span>
<span><span class="va">X_cent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">X_cent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">X_cent</span>, center <span class="op">=</span> <span class="cn">T</span>, scale <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> </span>
<span><span class="va">lambda</span> <span class="op">=</span> <span class="fl">10</span><span class="op">^</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">5</span>, length.out<span class="op">=</span><span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">kern</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/dots.html" class="external-link">vanilladot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cv_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/cv.kerndwd.html" class="external-link">cv.kerndwd</a></span><span class="op">(</span><span class="va">X_cent</span>, <span class="va">barcodeVec</span>, <span class="va">kern</span>, qval<span class="op">=</span><span class="fl">1</span>, lambda<span class="op">=</span><span class="va">lambda</span>, eps<span class="op">=</span><span class="fl">1e-5</span>, maxit<span class="op">=</span><span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="va">da_res</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/kerndwd.html" class="external-link">kerndwd</a></span><span class="op">(</span><span class="va">X_cent</span>, <span class="va">barcodeVec</span>, <span class="va">kern</span>, qval<span class="op">=</span><span class="fl">1</span>, lambda<span class="op">=</span><span class="va">cv_res</span><span class="op">$</span><span class="va">lambda.min</span>, eps<span class="op">=</span><span class="fl">1e-5</span>, maxit<span class="op">=</span><span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="va">dwdLoad</span> <span class="op">&lt;-</span> <span class="va">da_res</span><span class="op">$</span><span class="va">alpha</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,,drop<span class="op">=</span><span class="cn">F</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`dimnames&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">X_cent</span><span class="op">)</span>,<span class="st">"comp1"</span><span class="op">)</span><span class="op">)</span> <span class="co"># worked out by looking at predict.dwd</span></span>
<span><span class="va">dwdScore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/kerndwd/man/predict.kerndwd.html" class="external-link">predict.kerndwd</a></span><span class="op">(</span><span class="va">da_res</span>, <span class="va">kern</span>, <span class="va">X_cent</span>, <span class="va">X_cent</span>, <span class="st">"link"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`colnames&lt;-`</span><span class="op">(</span><span class="st">"comp1"</span><span class="op">)</span></span>
<span><span class="va">dwd_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scores <span class="op">=</span> <span class="va">dwdScore</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>, loadings <span class="op">=</span> <span class="va">dwdLoad</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>It seems that barcoded and non-barcoded bins were somewhat separable.
And the cell type signals explaining their separation were also plotted.
This low level of separation (compared to those seen in Visium and CosMx
case studies) is expected, since we are analysing a liquid cancer at its
late metastasis stage in the current case study. This means that the
cancer cells permeated the poor mouse’s spleen so the barcoded and
non-barcoded bins might not be easily distinguishable.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">barcodedOrNo</span> <span class="op">&lt;-</span> <span class="va">barcodeVec</span></span>
<span><span class="va">barcodedOrNo</span><span class="op">[</span><span class="va">barcodeVec</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Barcoded"</span></span>
<span><span class="va">barcodedOrNo</span><span class="op">[</span><span class="va">barcodeVec</span><span class="op">==</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"Nonbarcoded"</span></span>
<span><span class="va">dwd_res</span><span class="op">$</span><span class="va">scores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>niche <span class="op">=</span> <span class="va">barcodedOrNo</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">comp1</span>, fill <span class="op">=</span> <span class="va">niche</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/theme_pubr.html" class="external-link">theme_pubr</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"DWD score"</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loadBarplot.html">loadBarplot</a></span><span class="op">(</span></span>
<span>  <span class="va">dwd_res</span><span class="op">$</span><span class="va">loadings</span>, comp <span class="op">=</span> <span class="st">"comp1"</span>, showInt <span class="op">=</span> <span class="cn">F</span>, </span>
<span>  nfeat <span class="op">=</span> <span class="fl">10</span>, fsize <span class="op">=</span> <span class="fl">12</span>, xlab <span class="op">=</span> <span class="st">"DWD loading"</span>, absVal <span class="op">=</span> <span class="cn">T</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-19-2.png" width="700"></p>
<p>Recall that we defined meta-clones summarising spatial territories of
individual clones. We can now look at how these meta-clones differ in
terms of their cell states. Note that the neutrophil identity was
enriched in meta-clone 2, which is consistent with what we’ve been
observing.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clustBar</span> <span class="op">&lt;-</span> <span class="va">clust_list</span><span class="op">[[</span><span class="va">clustIdx</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">`names&lt;-`</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">barAssay</span><span class="op">)</span><span class="op">)</span> <span class="co"># containing all barcoded bins in and out spleen</span></span>
<span><span class="va">plot_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> </span>
<span><span class="va">clustBar</span> <span class="op">&lt;-</span> <span class="va">clustBar</span><span class="op">[</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">intersect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">plot_dat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clustBar</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"background"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">plot_dat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">plot_dat</span><span class="op">)</span></span>
<span><span class="va">clust</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clustBar</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">clustBar</span><span class="op">)</span></span>
<span><span class="co"># Select some clusters</span></span>
<span><span class="va">selectedClust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2"</span>, <span class="st">"3"</span>, <span class="st">"5"</span>, <span class="st">"6"</span>, <span class="st">"7"</span>, <span class="st">"8"</span>, <span class="st">"10"</span>, <span class="st">"background"</span><span class="op">)</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="va">clust</span><span class="op">[</span><span class="va">clust</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">selectedClust</span><span class="op">]</span></span>
<span><span class="va">clust</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">clust</span>, levels <span class="op">=</span> <span class="va">selectedClust</span><span class="op">)</span></span>
<span><span class="va">plot_dat</span> <span class="op">&lt;-</span> <span class="va">plot_dat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cluster <span class="op">=</span> <span class="va">clust</span>, x <span class="op">=</span> <span class="va">query</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">x</span>, y <span class="op">=</span> <span class="va">query</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span><span class="op">]</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="va">cTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span></span>
<span>  <span class="va">p_boxs</span> <span class="op">&lt;-</span> <span class="fu">tempSaveBox</span><span class="op">(</span><span class="va">plot_dat</span>, <span class="va">cTypes</span>, width <span class="op">=</span> <span class="fl">7</span>, height <span class="op">=</span> <span class="fl">10</span>, fignrow <span class="op">=</span> <span class="fl">8</span>, figncol <span class="op">=</span> <span class="fl">9</span>, fsize <span class="op">=</span> <span class="fl">5</span>, returnPlot <span class="op">=</span> <span class="cn">T</span>, savePlots <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">p_boxs</span><span class="op">$</span><span class="va">`Neutro(Spleen)`</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>,axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span><span class="op">)</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face <span class="op">=</span> <span class="st">"bold"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="StereoSeq_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>We conduct statistical tests to see which clusters have
differentially enriched cell types compared to background (non-barcoded
bins). Interestingly, these meta-clones, defined according to their
spatial locations, tended to have cell states corresponding to different
lineage. However, meta-clones close to each other tended to have similar
cell states (in terms on lineage). Overall, we observed three types of
cell states:</p>
<ul>
<li><p>Neutrophil-like: meta-clones 2 and 7;</p></li>
<li><p>Myeloid-like: meta-clones 3 and 8;</p></li>
<li><p>Erythrocyte-like: meta-clones 6.</p></li>
</ul>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathSigScores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">dat_dir</span>, <span class="st">"output/sigScores.qs"</span><span class="op">)</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">pathSigScores</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">cTypes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>    <span class="va">cTypes</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">cType</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">sc_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span>,<span class="va">cType</span><span class="op">]</span>, <span class="va">clust</span><span class="op">)</span></span>
<span>      <span class="va">bkgrd</span> <span class="op">&lt;-</span> <span class="va">sc_split</span><span class="op">$</span><span class="va">background</span></span>
<span>      <span class="va">sc_split</span><span class="op">[[</span><span class="st">"background"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> </span>
<span>      <span class="va">testRes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sc_split</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/wilcox.test.html" class="external-link">wilcox.test</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">bkgrd</span><span class="op">)</span><span class="op">$</span><span class="va">p.value</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">testRes</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span> </span>
<span>  <span class="va">fc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span></span>
<span>    <span class="va">cTypes</span>,</span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">cType</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">sc_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/reducedDims.html" class="external-link">reducedDim</a></span><span class="op">(</span><span class="va">query</span>, <span class="st">"PhiSpace"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">clust</span><span class="op">)</span>,<span class="va">cType</span><span class="op">]</span>, <span class="va">clust</span><span class="op">)</span></span>
<span>      <span class="va">bkgrd</span> <span class="op">&lt;-</span> <span class="va">sc_split</span><span class="op">$</span><span class="va">background</span></span>
<span>      <span class="va">sc_split</span><span class="op">[[</span><span class="st">"background"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>      <span class="va">foldChange</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sc_split</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">bkgrd</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">bkgrd</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">foldChange</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">sigScores</span> <span class="op">&lt;-</span> <span class="va">fc</span> <span class="op">*</span> <span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">pvals</span><span class="op">)</span><span class="op">)</span> <span class="co"># feature significance score </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qsave.html" class="external-link">qsave</a></span><span class="op">(</span><span class="va">sigScores</span>, <span class="va">pathSigScores</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">sigScores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/qs/man/qread.html" class="external-link">qread</a></span><span class="op">(</span><span class="va">pathSigScores</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># most enriched</span></span>
<span><span class="va">tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/selectFeat.html">selectFeat</a></span><span class="op">(</span><span class="va">sigScores</span>, absVal <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">$</span><span class="va">orderedFeatMat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sigScores</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5"</span>,<span class="st">"9"</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">tab</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="15%">
<col width="19%">
<col width="14%">
<col width="16%">
<col width="19%">
<col width="14%">
</colgroup>
<thead><tr class="header">
<th align="left">2</th>
<th align="left">3</th>
<th align="left">6</th>
<th align="left">7</th>
<th align="left">8</th>
<th align="left">10</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Neutro(Spleen)</td>
<td align="left">CD8 T(Spleen)</td>
<td align="left">T1(Neutro)</td>
<td align="left">HPC(BM)</td>
<td align="left">HPC(BM)</td>
<td align="left">HPC(BM)</td>
</tr>
<tr class="even">
<td align="left">Granulo(BM)</td>
<td align="left">Imm NK(BM)</td>
<td align="left">cDC1(CITE)</td>
<td align="left">Neutro(Spleen)</td>
<td align="left">CD8 T(Spleen)</td>
<td align="left">HSPC(Spleen)</td>
</tr>
<tr class="odd">
<td align="left">Neutro(CITE)</td>
<td align="left">T(BM)</td>
<td align="left">MAT 5(Neutro)</td>
<td align="left">Ly6+ mono(CITE)</td>
<td align="left">Ly6+ mono(CITE)</td>
<td align="left">CD8 T(Spleen)</td>
</tr>
<tr class="even">
<td align="left">HPC(BM)</td>
<td align="left">HPC(BM)</td>
<td align="left">cDC(Spleen)</td>
<td align="left">IMM 1(Neutro)</td>
<td align="left">Pre-B cycl(Spleen)</td>
<td align="left">pDC(Spleen)</td>
</tr>
<tr class="odd">
<td align="left">IMM 1(Neutro)</td>
<td align="left">Pre-B cycl(Spleen)</td>
<td align="left">Mono(BM)</td>
<td align="left">Granulo(BM)</td>
<td align="left">Imm NK(BM)</td>
<td align="left">B1 B(CITE)</td>
</tr>
</tbody>
</table>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/jiadongm" class="external-link">Jiadong Mao</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer>
</div>






  </body>
</html>
