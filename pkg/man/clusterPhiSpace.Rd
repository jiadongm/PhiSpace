% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/clusterPhiSpace.R
\name{clusterPhiSpace}
\alias{clusterPhiSpace}
\title{K-means clustering on PhiSpace principal components}
\usage{
clusterPhiSpace(
  x,
  k = NULL,
  k_range = NULL,
  select_k_method = c("silhouette", "elbow"),
  ncomp = NULL,
  reducedDimName = "PhiSpace",
  use_assay = NULL,
  nstart = 20,
  iter.max = 500,
  algorithm = c("Lloyd", "Hartigan-Wong", "MacQueen", "Forgy"),
  center = TRUE,
  scale = FALSE,
  seed = NULL,
  return_pca = TRUE,
  store_in_colData = FALSE,
  cluster_name = "PhiClust"
)
}
\arguments{
\item{x}{Either a SpatialExperiment/SingleCellExperiment object containing
PhiSpace scores in reducedDim, OR a matrix-like object (matrix, sparse matrix,
data frame) with features in columns and observations in rows.}

\item{k}{Integer specifying the number of clusters. Either provide k or
k_range but not both.}

\item{k_range}{Integer vector of length 2 specifying range of k values to
test (e.g., c(5, 15)). Will use elbow method or silhouette to select
optimal k. Either provide k or k_range but not both.}

\item{select_k_method}{Character string specifying method to select optimal k
when k_range is provided. Options: "elbow" (total within-cluster SS) or
"silhouette" (average silhouette width). Default is "silhouette".}

\item{ncomp}{Integer specifying number of principal components to use for
clustering. If NULL (default), uses min(30, nfeatures - 1). If "all",
uses nfeatures - 1 components.}

\item{reducedDimName}{Character string specifying which reducedDim slot
contains the PhiSpace scores. Only used when x is a SingleCellExperiment
or SpatialExperiment. Default is "PhiSpace".}

\item{use_assay}{Character string specifying which assay to use if extracting
data from a SingleCellExperiment/SpatialExperiment object instead of using
reducedDim. If NULL (default), uses reducedDim specified by reducedDimName.
Common options: "logcounts", "counts", "normcounts".}

\item{nstart}{Integer specifying number of random starts for k-means.
Default is 20.}

\item{iter.max}{Integer specifying maximum number of iterations.
Default is 500.}

\item{algorithm}{Character string specifying k-means algorithm. Options are
"Hartigan-Wong", "Lloyd", "Forgy", "MacQueen". Default is "Lloyd".}

\item{center}{Logical indicating whether to center data before PCA.
Default is TRUE.}

\item{scale}{Logical indicating whether to scale data before PCA.
Default is FALSE.}

\item{seed}{Integer seed for reproducibility. Default is NULL (no seed set).}

\item{return_pca}{Logical indicating whether to return PCA results.
Default is TRUE.}

\item{store_in_colData}{Logical indicating whether to store cluster assignments
in the colData of the input object (only applicable when x is an SCE/SPE).
Default is FALSE.}

\item{cluster_name}{Character string specifying the column name for cluster
assignments if store_in_colData is TRUE. Default is "PhiClust".}
}
\value{
A list with class "PhiSpaceClustering" containing:
\item{clusters}{Factor vector of cluster assignments}
\item{cluster_centers}{Matrix of cluster centers in PC space}
\item{kmeans_result}{Full kmeans object from stats::kmeans}
\item{pca_result}{PCA results (if return_pca = TRUE)}
\item{pc_scores}{Matrix of PC scores used for clustering}
\item{optimal_k}{Selected k value (relevant when k_range is used)}
\item{k_selection}{List with selection metrics (if k_range was used)}
\item{parameters}{List of parameters used}
\item{spe}{Updated object (if store_in_colData = TRUE and x is SCE/SPE)}
}
\description{
Performs k-means clustering on principal components derived from PhiSpace
scores or any other matrix-like data. This is useful for identifying spatial
niches or clusters based on cell state compositions or gene expression patterns.
}
\details{
This function implements a common workflow for spatial clustering:
\enumerate{
\item Extract data (from reducedDim, assay, or use directly if matrix)
\item Perform PCA to reduce dimensionality
\item Select top principal components
\item Apply k-means clustering
}

The function can either:
\itemize{
\item Use a fixed k value (specify k parameter)
\item Automatically select k from a range (specify k_range parameter)
}

When k_range is provided, the function tests all k values in the range and
selects the optimal k using either:
\itemize{
\item \strong{Silhouette method} (default): Maximizes average silhouette width
\item \strong{Elbow method}: Identifies elbow point in total within-cluster sum of squares
}
}
\section{Input Types}{

The function accepts multiple input types:
\itemize{
\item \strong{SingleCellExperiment/SpatialExperiment}: Uses reducedDim (default) or assay
\item \strong{Matrix}: Standard R matrix with observations in rows
\item \strong{Sparse matrix}: dgCMatrix or similar sparse formats
\item \strong{Data frame}: Coerced to matrix
}
}

\section{PCA Parameters}{

The number of PCs to use affects clustering resolution:
\itemize{
\item Fewer PCs (e.g., 10-15): Broader, more general clusters
\item More PCs (e.g., 30-50): Finer, more specific clusters
\item Default (30): Good balance for most applications
}
}

\section{K-means Algorithm}{

\itemize{
\item \strong{Lloyd} (default): Standard algorithm, good balance of speed and quality
\item \strong{Hartigan-Wong}: Often better results but slower
\item \strong{MacQueen}: Faster but may converge to local optima
\item \strong{Forgy}: Similar to Lloyd
}
}

\examples{
\dontrun{
# Example 1: Using SingleCellExperiment with PhiSpace scores
result <- clusterPhiSpace(
  x = lung_data,
  k = 9,
  ncomp = 30,
  seed = 123
)

# Example 2: Using matrix directly
phi_matrix <- reducedDim(lung_data, "PhiSpace")
result <- clusterPhiSpace(
  x = phi_matrix,
  k = 9,
  ncomp = 30
)

# Example 3: Cluster on normalized counts instead
result <- clusterPhiSpace(
  x = lung_data,
  use_assay = "logcounts",
  k = 9,
  ncomp = 50
)

# Example 4: Using data frame
df <- as.data.frame(reducedDim(lung_data, "PhiSpace"))
result <- clusterPhiSpace(x = df, k = 9)

# Example 5: Automatic k selection
result <- clusterPhiSpace(
  x = phi_matrix,
  k_range = c(5, 15),
  select_k_method = "silhouette"
)
}

}
